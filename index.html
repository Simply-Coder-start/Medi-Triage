<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Medi Triage â€” Gmail Signup</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root{ --bg:#0f1724; --muted:#9aa7c0; --danger:#ef4444; --accent1: #7b61ff; --accent2: #06f; }
  html,body{height:100%; margin:0; background:
    radial-gradient(1200px 600px at 10% 10%, rgba(123,97,255,0.06), transparent),
    linear-gradient(180deg,#071026 0%, #07162a 100%); color:#e6eef8; font-family:Inter,system-ui,Arial,Helvetica,sans-serif;}
  html.light-mode, html.light-mode body{ --bg: #f7fafc; --muted: #475569; --danger: #dc2626; }
  html.light-mode body{ background: linear-gradient(180deg,#ffffff 0%, #f1f5f9 100%); color:#0b1220; }

  .app{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px;}
  .card{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.05); border-radius:18px; box-shadow: 0 6px 30px rgba(2,6,23,0.6); padding:22px; max-width:1100px; width:100%; position:relative;}
  html.light-mode .card{ background: #ffffff; border:1px solid rgba(2,6,23,0.08); box-shadow: 0 6px 30px rgba(15,23,42,0.12); color:#0b1220; }

  .brand-row{ display:flex; gap:12px; align-items:center; margin-bottom:8px; }
  .logo{ width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:26px; background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:white; overflow:hidden; }
  h1{margin:0} .tiny{ font-size:12px; color:var(--muted); }
  .center{ display:flex; flex-direction:column; align-items:center; text-align:center; }

  /* --- Top controls (updated) --- */
  .top-controls{
    position:fixed;
    right:14px;
    top:14px;
    display:flex;
    gap:10px;
    align-items:center;
    z-index:9999;
    background:transparent;
    padding:6px;
  }

  .top-controls .ctrl-btn{
    background: rgba(255,255,255,0.02);
    border:1px solid rgba(255,255,255,0.04);
    padding:8px 12px;
    border-radius:12px;
    cursor:pointer;
    color:var(--muted);
    font-weight:600;
    display:flex;
    gap:8px;
    align-items:center;
    backdrop-filter: blur(6px);
    transition: transform .14s ease, box-shadow .14s ease;
  }

  .top-controls .ctrl-btn:hover{
    transform: translateY(-4px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.45);
  }

  @keyframes doctorPulse {
    0% { box-shadow: 0 0 0 0 rgba(123,97,255,0.16); }
    70% { box-shadow: 0 0 0 10px rgba(123,97,255,0); }
    100% { box-shadow: 0 0 0 0 rgba(123,97,255,0); }
  }
  .top-controls .ctrl-btn.doctor {
    border: 1px solid rgba(123,97,255,0.28);
    animation: doctorPulse 2.8s infinite;
  }

  .top-controls .ctrl-btn img{ display:block; width:20px; height:20px; border-radius:6px; object-fit:cover; }

  .landing{ display:grid; grid-template-columns:1fr 1fr; gap:18px; align-items:center; }

  .big-btn{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; border-radius:20px; cursor:pointer; transition:transform .28s, box-shadow .28s; background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); text-align:center; padding:18px; }
  .big-btn:hover{ transform:translateY(-8px) scale(1.01); box-shadow:0 18px 60px rgba(0,0,0,0.6); }

  .big-btn.patient-large{ height:260px; grid-column: span 2; font-size:16px; }
  .big-btn.patient-large .big-emoji{ font-size:64px; }
  .big-btn.patient-large .big-title{ font-size:34px; font-weight:800; }

  .big-emoji{ font-size:64px; } .big-title{ font-size:34px; font-weight:800; } .big-sub{ color:var(--muted); font-size:14px; text-align:center; }

  .page{ display:none; } .page.active{ display:block; animation:fadeInUp .32s ease both; }
  @keyframes fadeInUp{ from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

  .field{ display:flex; flex-direction:column; gap:8px; margin-bottom:12px; }
  input, textarea, select{ background:transparent; border:1px solid rgba(255,255,255,0.04); padding:12px 14px; border-radius:12px; color:#e6eef8; outline:none; font-size:14px; }
  input::placeholder, textarea::placeholder { color: rgba(255,255,255,0.3); }
  select { background: linear-gradient(180deg, rgba(20,30,50,0.8), rgba(15,20,40,0.8)); color: #ffffff; }
  select option { background: #0f1724; color: #ffffff; }
  textarea{ resize:vertical; min-height:80px; }
  
  /* Clinic Location Autocomplete Styles */
  #ds-location-container { position: relative; }
  #clinic-suggestions-dropdown { background-color: #0f1724; border: 1px solid rgba(255,255,255,0.1); border-radius: 0 0 12px 12px; color: #e6eef8; scrollbar-width: thin; scrollbar-color: rgba(123,97,255,0.3) transparent; }
  #clinic-suggestions-dropdown::-webkit-scrollbar { width: 6px; }
  #clinic-suggestions-dropdown::-webkit-scrollbar-track { background: transparent; }
  #clinic-suggestions-dropdown::-webkit-scrollbar-thumb { background: rgba(123,97,255,0.3); border-radius: 3px; }
  .clinic-suggestion:hover { background-color: rgba(123,97,255,0.2) !important; }
  .btn{ padding:10px 14px; border-radius:12px; border:none; cursor:pointer; font-weight:600; background:#0f1b2a; color:#e6eef8; }
  .btn.primary{ background: linear-gradient(90deg,var(--accent2),var(--accent1)); color:white; box-shadow:0 8px 30px rgba(107,72,255,0.12); }
  .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); }

  .btn.gmail{ background: #fff; color:#111; border:1px solid rgba(0,0,0,0.06); display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; }

  html.light-mode input, html.light-mode textarea, html.light-mode select{ color:#0b1220; border:1px solid rgba(2,6,23,0.06); background:rgba(2,6,23,0.02); }
  html.light-mode input::placeholder, html.light-mode textarea::placeholder { color: rgba(2,6,23,0.4); }
  html.light-mode select { background: linear-gradient(180deg, rgba(240,245,250,0.8), rgba(230,240,250,0.8)); color: #0b1220; }
  html.light-mode select option { background: #ffffff; color: #0b1220; }
  html.light-mode .btn{ background:#ffffff; color:#0b1220; border:1px solid rgba(2,6,23,0.06); }
  html.light-mode .btn.primary{ background: linear-gradient(90deg,var(--accent1),var(--accent2)); color:white; box-shadow:0 8px 30px rgba(107,72,255,0.06); }
  html.light-mode .btn.ghost{ background:transparent; border:1px solid rgba(2,6,23,0.06); color:var(--muted); }

  .q-card{ margin-top:12px; } .question{ font-size:18px; font-weight:700; margin-bottom:12px; }
  .options{ display:grid; gap:8px; } .option{ padding:12px; border-radius:12px; background:rgba(255,255,255,0.02); cursor:pointer; }
  .option.selected{ transform:translateY(-4px); box-shadow:0 14px 40px rgba(7,20,40,0.6); border:1px solid rgba(107,72,255,0.36); }

  .doctor-list{ display:grid; gap:10px; margin-top:12px; }
  .doctor-item{ display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px; background: rgba(0,0,0,0.24); border:1px solid rgba(255,255,255,0.02); }
  .doc-avatar{ width:56px; height:56px; border-radius:12px; background:linear-gradient(90deg,var(--accent1),var(--accent2)); display:flex; align-items:center; justify-content:center; font-weight:800; font-size:18px; color:white; }
  .doc-meta{ flex:1; } .doc-name{ font-weight:700; } .doc-sub{ color:var(--muted); font-size:13px; margin-top:4px; }

  .modal-backdrop{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(2,6,23,0.6); z-index:1200; }
  .modal{ background:#061226; border-radius:12px; padding:18px; width:420px; max-width:92%; border:1px solid rgba(255,255,255,0.04); box-shadow:0 18px 60px rgba(0,0,0,0.6); }
  .error-text{ color:var(--danger); font-weight:700; text-align:center; margin-top:8px; }
  .success-text{ color:#4ade80; font-weight:700; text-align:center; margin-top:8px; }

  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:32px; background:linear-gradient(90deg,var(--accent2),var(--accent1)); padding:10px 16px; border-radius:12px; color:white; box-shadow:0 10px 40px rgba(11,12,30,0.6); display:none; z-index:1000; }

  /* Local alert modal for MCQ validation */
  .alert-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); background: rgba(0,0,0,0.4); z-index: 9999; margin: 0; }
  .alert-box { background: #1e1e1e; padding: 28px 36px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); text-align: center; min-width: 300px; max-width: 400px; border: 1px solid rgba(255,255,255,0.08); margin: 0 auto; position: relative; }
  .alert-box p { margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: #e6eef8; }
  .alert-box button { margin-top: 8px; padding: 10px 28px; border-radius: 8px; background: linear-gradient(90deg, var(--accent2), var(--accent1)); color: white; border: none; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(107, 72, 255, 0.3); transition: all 0.2s ease; }
  .alert-box button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(107, 72, 255, 0.4); }

  /* ---------- Doctor Quick-View Modal ---------- */
  .doctor-quick-modal-overlay { 
    position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
    width: 100%; height: 100%; 
    display: flex; align-items: center; justify-content: center; 
    -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); 
    background: rgba(0,0,0,0.5); z-index: 10000; margin: 0; 
  }
  .doctor-quick-modal { 
    background: linear-gradient(180deg, rgba(30,30,30,0.98), rgba(20,20,20,0.98)); 
    padding: 0; border-radius: 16px; 
    box-shadow: 0 20px 60px rgba(0,0,0,0.7); 
    width: 520px; max-width: 94vw; 
    border: 1px solid rgba(255,255,255,0.1); 
    position: relative; max-height: 90vh; overflow: hidden;
    display: flex; flex-direction: column;
  }
  .doctor-quick-modal-header { 
    display: flex; gap: 14px; align-items: center; 
    padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.08); 
    background: rgba(0,0,0,0.2);
  }
  .doctor-quick-modal-avatar { 
    width: 64px; height: 64px; border-radius: 12px; 
    background: linear-gradient(135deg, var(--accent1), var(--accent2)); 
    display: flex; align-items: center; justify-content: center; 
    font-weight: 800; font-size: 22px; color: white; 
    flex-shrink: 0;
  }
  .doctor-quick-modal-title { flex: 1; }
  .doctor-quick-modal-title h3 { margin: 0 0 4px 0; font-size: 20px; font-weight: 800; }
  .doctor-quick-modal-title .specialty-badge { 
    display: inline-block; padding: 4px 10px; border-radius: 6px; 
    font-size: 12px; font-weight: 600; 
    background: rgba(123,97,255,0.15); color: var(--accent1); 
  }
  .doctor-quick-modal-close { 
    background: transparent; border: none; color: var(--muted); 
    font-size: 24px; cursor: pointer; padding: 4px 8px; 
    transition: color 0.2s ease;
  }
  .doctor-quick-modal-close:hover { color: #fff; }
  .doctor-quick-modal-body { 
    padding: 20px; overflow-y: auto; flex: 1;
  }
  .doctor-quick-modal-section { margin-bottom: 18px; }
  .doctor-quick-modal-section h4 { 
    margin: 0 0 10px 0; font-size: 14px; font-weight: 700; 
    color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;
  }
  .doctor-quick-map-preview { 
    width: 100%; height: 140px; border-radius: 10px; 
    background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.06); 
    overflow: hidden; position: relative;
  }
  .doctor-quick-map-preview iframe { 
    width: 100%; height: 100%; border: none; 
  }
  .doctor-quick-map-link { 
    display: flex; align-items: center; justify-content: center; 
    padding: 12px; background: rgba(123,97,255,0.08); 
    border-radius: 10px; gap: 8px; text-decoration: none; 
    color: var(--accent1); font-weight: 600; font-size: 14px;
    border: 1px solid rgba(123,97,255,0.2);
    transition: all 0.2s ease;
  }
  .doctor-quick-map-link:hover { 
    background: rgba(123,97,255,0.15); 
    transform: translateY(-2px);
  }
  .doctor-quick-clinic-details { 
    display: flex; flex-direction: column; gap: 10px; 
  }
  .doctor-quick-detail-row { 
    display: flex; align-items: flex-start; gap: 10px; 
    padding: 10px; background: rgba(255,255,255,0.02); 
    border-radius: 8px; border: 1px solid rgba(255,255,255,0.04);
  }
  .doctor-quick-detail-row .icon { 
    font-size: 16px; flex-shrink: 0; 
  }
  .doctor-quick-detail-row .content { flex: 1; }
  .doctor-quick-detail-row .content .label { 
    font-size: 12px; color: var(--muted); margin-bottom: 2px; 
  }
  .doctor-quick-detail-row .content .value { 
    font-size: 14px; font-weight: 600; 
  }
  .doctor-quick-detail-row a { 
    color: var(--accent1); text-decoration: none; 
  }
  .doctor-quick-detail-row a:hover { text-decoration: underline; }
  .doctor-quick-booking-form { display: flex; flex-direction: column; gap: 12px; }
  .doctor-quick-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .doctor-quick-modal-footer { 
    padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.08); 
    display: flex; gap: 10px; justify-content: flex-end; 
    background: rgba(0,0,0,0.2);
  }
  .doctor-quick-error { 
    color: var(--danger); font-size: 13px; font-weight: 600; 
    margin-top: 8px; padding: 8px 12px; 
    background: rgba(239,68,68,0.1); border-radius: 6px; 
    border: 1px solid rgba(239,68,68,0.2);
  }
  @media (max-width: 580px) {
    .doctor-quick-modal { width: 96vw; max-height: 95vh; }
    .doctor-quick-form-row { grid-template-columns: 1fr; }
  }

  /* ---------- New Booking Modal ---------- */
  .booking-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    background: rgba(0, 0, 0, 0.6);
    z-index: 11000;
    margin: 0;
  }
  .booking-modal {
    background: linear-gradient(180deg, rgba(30, 30, 30, 0.98), rgba(20, 20, 20, 0.98));
    padding: 0;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    width: 600px;
    max-width: 95vw;
    border: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    color: #e6eef8;
  }
  html.light-mode .booking-modal {
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(240, 245, 250, 0.98));
    border-color: rgba(0, 0, 0, 0.1);
    color: #0b1220;
  }
  .booking-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    background: rgba(0, 0, 0, 0.2);
  }
  html.light-mode .booking-modal-header {
    border-bottom-color: rgba(0, 0, 0, 0.08);
    background: rgba(0, 0, 0, 0.02);
  }
  .booking-modal-header-content {
    flex: 1;
  }
  .booking-modal-header h3 {
    margin: 0 0 6px 0;
    font-size: 22px;
    font-weight: 800;
    color: #e6eef8;
  }
  html.light-mode .booking-modal-header h3 {
    color: #0b1220;
  }
  .booking-modal-specialty {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    background: rgba(123, 97, 255, 0.15);
    color: var(--accent1);
    margin-bottom: 8px;
  }
  html.light-mode .booking-modal-specialty {
    background: rgba(123, 97, 255, 0.1);
  }
  .booking-modal-address {
    font-size: 13px;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  html.light-mode .booking-modal-address {
    color: #475569;
  }
  .booking-modal-close {
    background: transparent;
    border: none;
    color: var(--muted);
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    line-height: 1;
    transition: color 0.2s ease;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  html.light-mode .booking-modal-close {
    color: #475569;
  }
  .booking-modal-close:hover {
    color: #fff;
  }
  html.light-mode .booking-modal-close:hover {
    color: #0b1220;
  }
  .booking-modal-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
    background: inherit;
  }
  .booking-modal-section {
    margin-bottom: 20px;
  }
  .booking-modal-section h4 {
    margin: 0 0 12px 0;
    font-size: 14px;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  html.light-mode .booking-modal-section h4 {
    color: #475569;
  }
  .booking-map-container {
    width: 100%;
    height: 200px;
    border-radius: 10px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.06);
    overflow: hidden;
    position: relative;
  }
  html.light-mode .booking-map-container {
    background: rgba(0, 0, 0, 0.05);
    border-color: rgba(0, 0, 0, 0.1);
  }
  .booking-map-container iframe {
    width: 100%;
    height: 100%;
    border: none;
  }
  .booking-form-group {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }
  .booking-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .booking-modal-footer {
    padding: 20px 24px;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: rgba(0, 0, 0, 0.2);
  }
  html.light-mode .booking-modal-footer {
    border-top-color: rgba(0, 0, 0, 0.08);
    background: rgba(0, 0, 0, 0.02);
  }
  .booking-error {
    color: var(--danger);
    font-size: 13px;
    font-weight: 600;
    margin-top: 8px;
    padding: 10px 14px;
    background: rgba(239, 68, 68, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(239, 68, 68, 0.2);
  }
  @media (max-width: 640px) {
    .booking-modal {
      width: 96vw;
      max-height: 95vh;
    }
    .booking-form-row {
      grid-template-columns: 1fr;
    }
  }

  /* Severity level badges */
  .severity-critical { color: #ef4444; font-weight: 800; }
  .severity-high { color: #f97316; font-weight: 800; }
  .severity-moderate { color: #eab308; font-weight: 800; }
  .severity-low { color: #10b981; font-weight: 800; }

  @media (max-width:880px){
    .landing{ grid-template-columns:1fr; }
    .big-btn.patient-large{ grid-column: auto; height:200px; }
    .card{ padding:16px; }
    .top-controls{ right:10px; top:10px; gap:6px; }
  }

  /* ---------- Doctor Dashboard styles (kept minimal & inside same file) ---------- */
  .dash-page { display: none; }
  .dash-page.active { display: block; animation: fadeInUp .32s ease both; }
  .dashboard { display: grid; grid-template-columns: 1fr 360px; gap:16px; margin-top:8px; }
  .panel { background: rgba(0,0,0,0.16); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.02); }
  .kpis { display:flex; gap:10px; }
  .kpi { flex:1; padding:12px; border-radius:10px; text-align:center; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); }
  .kpi h3 { margin:0; font-size:13px; color:var(--muted); font-weight:700; }
  .kpi .num { font-size:20px; font-weight:800; margin-top:6px; }
  .requests-list { display:flex; flex-direction:column; gap:8px; max-height:460px; overflow:auto; margin-top:8px; }
  .req-item { display:flex; gap:10px; padding:10px; border-radius:10px; background: rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02); align-items:flex-start; }
  .req-avatar { width:44px; height:44px; border-radius:10px; background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:white; display:flex; align-items:center; justify-content:center; font-weight:800; }
  .req-main { flex:1; }
  .req-title { font-weight:800; }
  .badge { padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; }
  .badge.high { color:var(--danger); background: rgba(239,68,68,0.08); }
  .badge.medium { color:#f59e0b; background: rgba(245,158,11,0.06); }
  .badge.low { color:#10b981; background: rgba(16,185,129,0.04); }
  .appt-list { display:flex; flex-direction:column; gap:8px; max-height:300px; overflow:auto; margin-top:8px; }
  .appt-item { padding:8px; border-radius:8px; background: rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02); display:flex; justify-content:space-between; align-items:center; }

  /* ---------- Patient Dashboard specific styles ---------- */
  .patient-header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
  .patient-left{ display:flex; gap:12px; align-items:center; }
  .patient-avatar{ width:64px; height:64px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:20px; background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:white; }
  .patient-meta{ display:flex; flex-direction:column; gap:4px; }
  .patient-meta .name{ font-size:18px; font-weight:800; }
  .patient-meta .small{ font-size:13px; color:var(--muted); }
  .patient-right{ display:flex; gap:8px; align-items:center; }

  /* Light mode adjustments for cards/panels */
  html.light-mode .card-large{ background: #fafbfc; border:1px solid rgba(2,6,23,0.1); box-shadow: 0 2px 8px rgba(15,23,42,0.06); }
  html.light-mode .panel{ background: #f8fafc; border:1px solid rgba(2,6,23,0.08); box-shadow: none; color:#0b1220; }
  html.light-mode .timeline-item{ background: #ffffff; border:1px solid rgba(2,6,23,0.08); color:#0b1220; }
  html.light-mode .req-item{ background: #ffffff; border:1px solid rgba(2,6,23,0.08); }
  html.light-mode .appt-item{ background: #ffffff; border:1px solid rgba(2,6,23,0.08); color:#0b1220; }
  html.light-mode .small-card{ background: #fafbfc; border:1px solid rgba(2,6,23,0.08); box-shadow: 0 2px 8px rgba(15,23,42,0.04); color:#0b1220; }

  .main-cards{ display:grid; grid-template-columns: 1fr 220px; gap:12px; margin-bottom:12px; align-items:start; }
  .card-large{ background: rgba(255,255,255,0.02); padding:14px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); display:flex; flex-direction:column; gap:12px; }
  .small-card{ background: rgba(255,255,255,0.01); padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); text-align:center; }

  .grid-sections{ display:grid; grid-template-columns: 1fr 360px; gap:12px; align-items:start; }
  .grid-sections > div:last-child { display:flex; flex-direction:column; gap:12px; }
  .grid-sections > div:last-child .panel { margin-top:0 !important; }
  .timeline-item{ padding:8px; border-radius:10px; background: rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02); margin-bottom:8px; }

  .bottom-nav{ display:none; position:fixed; left:50%; transform:translateX(-50%); bottom:12px; background:rgba(0,0,0,0.4); padding:6px 10px; border-radius:999px; gap:10px; z-index:999; }
  .bottom-nav .b-item{ padding:8px 10px; border-radius:10px; background:transparent; border:none; color:var(--muted); font-weight:700; cursor:pointer; }
  @media (max-width:880px){ .bottom-nav{ display:flex; } .card{ padding-bottom:80px; } .dashboard, .grid-sections { grid-template-columns: 1fr; } .main-cards{ grid-template-columns: 1fr; } }

  /* --- AI CHAT BOT STYLES --- */
  .chat-btn-float {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent2), var(--accent1));
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    cursor: pointer;
    z-index: 2000;
    transition: transform 0.2s, box-shadow 0.2s;
    border: 2px solid rgba(255, 255, 255, 0.2);
  }

  .chat-btn-float:hover {
    transform: scale(1.08);
    box-shadow: 0 14px 50px rgba(0, 0, 0, 0.6);
  }

  .chat-window {
    position: fixed;
    bottom: 95px;
    right: 24px;
    width: 360px;
    height: 500px;
    background: var(--bg);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 18px;
    box-shadow: 0 12px 60px rgba(0, 0, 0, 0.7);
    display: none;
    flex-direction: column;
    z-index: 2000;
    overflow: hidden;
    backdrop-filter: blur(20px);
  }

  .chat-window.active {
    display: flex;
    animation: slideUpChat 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @keyframes slideUpChat {
    from { opacity: 0; transform: translateY(20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  .chat-header {
    padding: 14px 18px;
    background: linear-gradient(90deg, rgba(123, 97, 255, 0.1), transparent);
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .chat-title {
    font-weight: 800;
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .chat-body {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
    background: rgba(0, 0, 0, 0.2);
  }

  .chat-footer {
    padding: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.06);
    display: flex;
    gap: 8px;
    background: rgba(255, 255, 255, 0.01);
  }

  .chat-msg {
    max-width: 80%;
    padding: 10px 14px;
    border-radius: 14px;
    font-size: 14px;
    line-height: 1.4;
    word-wrap: break-word;
  }

  .chat-msg.bot {
    background: rgba(255, 255, 255, 0.06);
    align-self: flex-start;
    border-bottom-left-radius: 2px;
    color: #e6eef8;
  }

  .chat-msg.user {
    background: var(--accent1);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 2px;
  }

  #chat-input {
    flex: 1;
    padding: 8px 12px;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    outline: none;
    font-family: Inter, system-ui, Arial, sans-serif;
  }

  #chat-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
  }

  #chat-send {
    padding: 8px 12px;
    background: linear-gradient(90deg, var(--accent2), var(--accent1));
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 20px;
    font-weight: bold;
    transition: transform 0.2s;
  }

  #chat-send:hover {
    transform: scale(1.05);
  }

  @media (max-width: 480px) {
    .chat-window {
      width: 90%;
      right: 5%;
      bottom: 100px;
      height: 60%;
    }
  }

  /* Subscription page */
  .sub-container {
    width: 100%;
    max-width: 1000px;
    margin: 0 auto;
  }
  .sub-center {
    text-align: center;
    margin-bottom: 28px;
  }
  .sub-center h2 {
    font-size: 2rem;
    margin: 0 0 10px;
  }
  .sub-center .tiny {
    color: var(--muted);
  }
  .plan-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 18px;
    align-items: stretch;
  }
  .plan-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 18px;
    padding: 22px;
    position: relative;
    display: flex;
    flex-direction: column;
    text-align: center;
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
  }
  .plan-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 16px 36px rgba(0, 0, 0, 0.35);
    border-color: rgba(123, 97, 255, 0.35);
  }
  .plan-card.featured {
    background: linear-gradient(180deg, rgba(123, 97, 255, 0.08) 0%, rgba(255, 255, 255, 0.02) 100%);
    border: 1px solid var(--accent1);
    box-shadow: 0 0 24px rgba(123, 97, 255, 0.15);
  }
  .plan-badge {
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--accent1);
    color: white;
    font-size: 11px;
    font-weight: 800;
    padding: 5px 14px;
    border-radius: 20px;
    letter-spacing: 0.6px;
    box-shadow: 0 4px 12px rgba(123,97,255,0.4);
  }
  .plan-name { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
  .plan-price { font-size: 36px; font-weight: 800; margin-bottom: 6px; }
  .plan-price span { font-size: 15px; color: var(--muted); font-weight: 400; margin-left: 4px; }
  .plan-features { list-style: none; padding: 0; margin: 18px 0 24px; text-align: left; }
  .plan-features li { padding: 8px 0; color: var(--muted); font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.04); display: flex; align-items: center; gap: 8px; }
  .plan-features li:last-child { border-bottom: none; }
  .plan-features li strong { color: #e6eef8; font-weight: 600; }
  .sub-back-row { text-align: center; margin-top: 18px; }
</style>
</head>
<body>
  <div class="app">
    <div class="card" role="main" aria-labelledby="appTitle">

      <!-- top-controls (kept as in your file) -->
      <div class="top-controls" aria-hidden="false" id="topControls">
        <button type="button" class="ctrl-btn" id="ctrl-theme" title="Toggle dark / light">
          <span style="font-size:16px; line-height:1;">ğŸŒ™</span>
          <span class="label">Theme</span>
        </button>

        <button type="button" class="ctrl-btn" id="ctrl-sub" title="Subscribe">
          <span style="font-size:16px; line-height:1;">ğŸ””</span>
          <span class="label">Subscribe</span>
        </button>

        <button type="button" class="ctrl-btn doctor" id="ctrl-profile" title="Doctor profile (click to sign in)">
          <span style="font-size:16px; line-height:1;">ğŸ‘¨â€âš•ï¸</span>
          <span class="label">Doctor</span>
        </button>
      </div>

      <div class="brand-row">
        <div class="logo"><img src="https://image2url.com/images/1765345348431-ccebf22a-9a7e-41c3-af30-34f4c06da4d8.jpeg" alt="logo" style="width:100%;height:100%;object-fit:cover;border-radius:12px;"/></div>
        <div>
          <h1 id="appTitle">Medi Triage</h1>
          <div class="tiny">Gmail signup added</div>
        </div>
      </div>

      <!-- Landing: main content -->
      <section id="page-landing" class="page active">
        <div class="landing">
          <div class="big-btn patient-large" id="btn-patient" role="button" tabindex="0">
            <div class="big-emoji">ğŸ©ºğŸ‘©â€âš•ï¸</div>
            <div class="big-title">I am a Patient</div>
            <div class="big-sub">Quick symptoms test â†’ suggested doctors â†’ book</div>
          </div>

          <div style="display:flex;flex-direction:column;gap:12px;align-items:flex-start;">
            <div style="margin-top:8px;color:var(--muted);font-size:13px;">
              Clinician features are hidden from the main patient flow.
            </div>
          </div>
        </div>
        <p class="tiny" style="margin-top:14px;">Tip: Click Patient to try the flow: signup â†’ main symptom â†’ 10 MCQ â†’ suggested doctors.</p>
      </section>

      <!-- Patient signup -->
      <section id="page-patient-signup" class="page">
        <div class="center" style="gap:10px;">
          <h2>Patient â€” Create Account</h2>
          <p class="tiny">Quick signup â€” you'll go to Patient Dashboard after Create & Enter</p>
        </div>
        <div style="margin-top:12px; display:flex; flex-direction:column; align-items:center;">
          <div style="width:100%; max-width:420px;">
            <div class="field"><label>Full name <input id="ps-name" type="text" placeholder="e.g., Pritam Sahoo"></label></div>
            <div class="field"><label>Username <input id="ps-username" type="text" placeholder="choose username (optional)"></label></div>
            <div class="field"><label>Password <input id="ps-password" type="password" placeholder="password (min 6 chars)"></label></div>

            <div style="display:flex;gap:8px;justify-content:center;margin-top:8px;">
              <button class="btn primary" id="ps-create">Create & Enter</button>
              <button class="btn ghost" id="ps-back">Back</button>
            </div>

            <div style="margin-top:12px; text-align:center; display:flex; flex-direction:column; align-items:center; gap:10px;">
              <div class="tiny">Or</div>
              <div style="margin-top:2px;">
                <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-size="large"></div>
              </div>
              <div id="ps-error" class="error-text" style="display:none"></div>
              <div class="tiny" style="color:var(--muted)">Use a <strong>@gmail.com</strong> address.</div>
              <div>
                <button class="btn ghost" id="ps-goto-login" style="padding:6px 10px;">Already registered? Sign in</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Patient login -->
      <section id="page-patient-login" class="page">
        <div class="center" style="gap:10px;">
          <h2>Patient â€” Sign in</h2>
          <p class="tiny">Use your username and password to continue</p>
        </div>

        <div style="margin-top:12px; display:flex; flex-direction:column; align-items:center;">
          <div style="width:100%; max-width:420px; display:flex; flex-direction:column; gap:12px;">
            <div class="field"><label>Username <input id="pl-username" type="text" placeholder="your username"></label></div>
            <div class="field"><label>Password <input id="pl-password" type="password" placeholder="your password"></label></div>

            <div style="display:flex;gap:8px;justify-content:center;margin-top:4px;">
              <button class="btn primary" id="pl-login">Sign in</button>
              <button class="btn ghost" id="pl-back">Back</button>
            </div>

            <div id="pl-error" class="error-text" style="display:none"></div>
          </div>
        </div>
      </section>

      <!-- Patient Dashboard (NEW) -->
      <section id="page-patient-dashboard" class="page">
        <div class="patient-header">
          <div class="patient-left">
            <div id="patient-avatar" class="patient-avatar">PS</div>
            <div class="patient-meta">
              <div id="patient-name" class="name">Hello, Patient ğŸ‘‹</div>
              <div id="patient-quick" class="small">Age: â€” â€¢ Gender: â€” â€¢ Last check-up: â€”</div>
            </div>
          </div>
          <div class="patient-right">
            <button class="btn ghost" id="open-sub">Subscription</button>
            <button class="btn ghost" id="open-profile">Profile</button>
            <button class="btn ghost" id="toggle-theme-dash">Theme</button>
            <button class="btn ghost" id="patient-logout">Logout</button>
          </div>
        </div>

        <div class="main-cards" style="grid-template-columns:1fr;">
          <div class="card-large">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:800;font-size:20px">I am a Patient</div>
                <div class="tiny" style="margin-top:6px;color:var(--muted)">Main patient entry: symptom checker, requests, appointments.</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px">
                <button class="btn primary" id="dash-symptom-btn">Symptom Checker</button>
                <button class="btn ghost" id="dash-new-request">Send Request</button>
              </div>
            </div>

            <div style="margin-top:12px" id="dash-widgets">
              <div class="grid-sections" style="margin-top:12px">
                <div>
                  <div class="panel" id="panel-requests">
                    <h3>My Requests</h3>
                    <div id="dash-requests" style="margin-top:8px"></div>
                  </div>

                  <div class="panel" style="margin-top:12px" id="panel-appointments">
                    <h3>My Appointments</h3>
                    <div id="dash-appointments" style="margin-top:8px"></div>
                  </div>

                  <div class="panel" style="margin-top:12px" id="panel-reports">
                    <h3>My Reports</h3>
                    <div class="tiny" style="margin-top:8px;color:var(--muted)">Upload / View lab reports (demo: list files)</div>
                    <div style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                      <input type="file" id="report-file" accept="application/pdf,image/jpeg,image/png" style="display:none" />
                      <button class="btn ghost" id="report-choose">Choose PDF/JPG</button>
                      <span id="report-chosen" class="tiny" style="color:var(--muted)">No file chosen</span>
                      <button class="btn primary" id="report-upload">Upload</button>
                    </div>
                    <div id="dash-reports" style="margin-top:8px"></div>
                  </div>

                  <div class="panel" style="margin-top:12px" id="panel-timeline">
                    <h3>Health Timeline</h3>
                    <div id="dash-timeline" style="margin-top:8px"></div>
                    <div style="margin-top:8px;display:flex;gap:8px">
                      <input id="timeline-note" placeholder="Add daily note (symptom / sleep / water)" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)">
                      <button class="btn primary" id="timeline-add">Add</button>
                    </div>
                  </div>
                </div>

                <div>
                  <div class="panel" style="margin-top:12px" id="panel-saved-doctors">
                    <h3>Saved Doctors</h3>
                    <div id="dash-saved-doctors" style="margin-top:8px"></div>
                  </div>

                  <div class="panel" style="margin-top:12px" id="panel-notifications">
                    <h3>Notifications</h3>
                    <div id="dash-notifs" style="margin-top:8px"></div>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <!-- BEGIN: Doctor Sidebar (removed for patient view)
          <div class="small-card">
            <div style="font-weight:800">I am a Doctor</div>
            <div class="tiny" style="margin-top:6px;color:var(--muted)">Clinician sign-in & mini-dashboard</div>
            <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
              <button class="btn ghost" id="mini-doctor-login">Doctor Login</button>
              <button class="btn ghost" id="mini-doctor-create">Create Doctor Account</button>
            </div>
          </div>
          END: Doctor Sidebar -->
        </div>

        <!-- bottom nav (mobile) -->
        <div class="bottom-nav" role="navigation" aria-label="Bottom navigation">
          <button class="b-item" id="nav-home">Home</button>
          <button class="b-item" id="nav-appts">Appointments</button>
          <button class="b-item" id="nav-reports">Reports</button>
          <button class="b-item" id="nav-profile">Profile</button>
        </div>
      </section>

      <!-- Patient Edit Profile Page -->
      <section id="page-patient-edit-profile" class="page">
        <div class="center" style="gap:20px; width:100%; max-width:500px; margin:0 auto;">
          <h2>Edit Profile</h2>
          <p class="tiny">Update your personal information</p>

          <!-- Profile Photo Section -->
          <div style="text-align:center; width:100%;">
            <div id="pep-photo-preview" style="width:120px; height:120px; margin:0 auto 12px; border-radius:50%; background:#1a3a52; display:flex;align-items:center;justify-content:center; border:2px solid rgba(255,255,255,0.1); font-size:40px; overflow:hidden;">
              ğŸ‘¤
            </div>
            <label style="cursor:pointer;">
              <input type="file" id="pep-photo-input" accept="image/*" style="display:none;">
              <span class="btn ghost" style="display:inline-block; padding:6px 12px; font-size:13px;">Change Photo</span>
            </label>
            <div class="tiny" style="color:var(--muted); margin-top:6px;">JPG, PNG (max 5MB)</div>
          </div>

          <!-- Form Fields -->
          <div style="width:100%;">
            <div class="field"><label>Full name</label><input id="pep-name" type="text" placeholder="e.g., Pritam Sahoo"></div>
            
            <div class="field">
              <label>Age</label><input id="pep-age" type="number" min="1" max="120" placeholder="e.g., 28">
            </div>

            <div class="field"><label>Gender</label>
              <select id="pep-gender">
                <option value="">-- Select Gender --</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
                <option value="Prefer not to say">Prefer not to say</option>
              </select>
            </div>

            <div class="field">
              <label>Email</label><input id="pep-email" type="email" placeholder="e.g., pritam@example.com">
            </div>

            <div class="field">
              <label>Phone</label>
              <div style="display:flex;gap:8px;">
                <select id="pep-country-code" style="width:120px;">
                  <option value="+91">ğŸ‡®ğŸ‡³ +91</option>
                  <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
                  <option value="+44">ğŸ‡¬ğŸ‡§ +44</option>
                  <option value="+61">ğŸ‡¦ğŸ‡º +61</option>
                  <option value="+81">ğŸ‡¯ğŸ‡µ +81</option>
                  <option value="+86">ğŸ‡¨ğŸ‡³ +86</option>
                  <option value="+49">ğŸ‡©ğŸ‡ª +49</option>
                  <option value="+33">ğŸ‡«ğŸ‡· +33</option>
                  <option value="+971">ğŸ‡¦ğŸ‡ª +971</option>
                  <option value="+65">ğŸ‡¸ğŸ‡¬ +65</option>
                </select>
                <input id="pep-phone" type="tel" placeholder="XXXXXXXXXX" style="flex:1;">
              </div>
            </div>

            <div class="field">
              <label>Address</label><textarea id="pep-address" placeholder="e.g., 123 Main St, Mumbai, Maharashtra"></textarea>
            </div>

            <div class="field">
              <label>Last Checkup Date</label><input id="pep-lastCheckup" type="date">
            </div>

            <div class="field"><label>Password</label><input id="pep-password" type="password" placeholder="Leave blank to keep current (min 6 chars)"></div>

            <div style="display:flex;gap:8px;justify-content:center;margin-top:16px; width:100%;">
              <button type="button" class="btn primary" id="pep-save">Save Changes</button>
              <button type="button" class="btn ghost" id="pep-cancel">Cancel</button>
            </div>

            <div id="pep-error" class="error-text" style="display:none; width:100%;"></div>
            <div id="pep-success" class="success-text" style="display:none; width:100%;"></div>
          </div>
        </div>
      </section>

      <!-- Subscription page -->
      <section id="page-subscription" class="page">
        <div class="sub-container">
          <div class="sub-center">
            <h2>Upgrade to Medi+</h2>
            <p class="tiny">Faster care, smart insights, and family protection.</p>
          </div>

          <div class="plan-grid">
            <div class="plan-card" id="plan-basic">
              <div class="plan-name">Basic</div>
              <div class="plan-price">Free</div>
              <ul class="plan-features">
                <li>ğŸ©º Symptom Checker</li>
                <li>ğŸ‘¨â€âš•ï¸ Standard Doctor Booking</li>
                <li>ğŸ“ Local Health History</li>
                <li>âŒ No AI Assistant</li>
              </ul>
              <button class="btn ghost" style="width:100%" id="sub-basic-btn">Current Plan</button>
            </div>

            <div class="plan-card featured" id="plan-gold">
              <div class="plan-badge">Most Popular</div>
              <div class="plan-name">Gold Member</div>
              <div class="plan-price">â‚¹199<span>/mo</span></div>
              <ul class="plan-features">
                <li>âš¡ <strong>Priority Triage</strong> (Top of List)</li>
                <li>ğŸ¤– <strong>Unlimited</strong> AI Chat</li>
                <li>ğŸ“‚ Cloud Report Storage</li>
                <li>ğŸ”” Medicine Reminders</li>
              </ul>
              <button class="btn primary" style="width:100%" id="sub-gold-btn">Upgrade to Gold</button>
            </div>

            <div class="plan-card" id="plan-family">
              <div class="plan-name">Family Shield</div>
              <div class="plan-price">â‚¹499<span>/mo</span></div>
              <ul class="plan-features">
                <li>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ <strong>Up to 4 Members</strong></li>
                <li>ğŸ†˜ One-Click Emergency</li>
                <li>ğŸ©¸ Home Lab Collection</li>
                <li>ğŸ“ 24/7 Doctor Helpline</li>
              </ul>
              <button class="btn ghost" style="width:100%" id="sub-family-btn">Upgrade to Family</button>
            </div>
          </div>

          <div class="sub-back-row">
            <button class="btn ghost" id="sub-back-btn">Back to Dashboard</button>
          </div>
        </div>
      </section>

      <!-- Doctor signup -->
      <section id="page-doctor-signup" class="page">
        <div class="center" style="gap:10px;">
          <h2>Doctor â€” Create Account</h2>
          <p class="tiny">Register as a clinician to receive patient requests (demo uses localStorage).</p>
        </div>
        <div style="margin-top:12px;">
          <div class="field"><label>Full name <input id="ds-name" type="text" placeholder="e.g., Dr. Arup Sen"></label></div>
          <div class="field"><label>Username <input id="ds-username" type="text" placeholder="choose username (optional)"></label></div>
          <div class="field"><label>Password <input id="ds-password" type="password" placeholder="password (min 6 chars)"></label></div>
          <div class="field"><label>Specialty 
            <select id="ds-specialty" required>
              <option value="">-- Select Specialty --</option>
              <option value="Cardiology">Cardiology</option>
              <option value="Dermatology">Dermatology</option>
              <option value="Endocrinology">Endocrinology</option>
              <option value="ENT">ENT (Ear, Nose, Throat)</option>
              <option value="Gastroenterology">Gastroenterology</option>
              <option value="General Practice">General Practice</option>
              <option value="Hematology">Hematology</option>
              <option value="Nephrology">Nephrology</option>
              <option value="Neurology">Neurology</option>
              <option value="Oncology">Oncology</option>
              <option value="Ophthalmology">Ophthalmology</option>
              <option value="Orthopedics">Orthopedics</option>
              <option value="Pediatrics">Pediatrics</option>
              <option value="Psychiatry">Psychiatry</option>
              <option value="Pulmonology">Pulmonology</option>
              <option value="Rheumatology">Rheumatology</option>
              <option value="Urology">Urology</option>
            </select>
          </label></div>
          <div class="field">
            <label>Phone</label>
            <div style="display:flex;gap:8px;">
              <select id="ds-country-code" style="width:120px;">
                <option value="+91">ğŸ‡®ğŸ‡³ +91</option>
                <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
                <option value="+44">ğŸ‡¬ğŸ‡§ +44</option>
                <option value="+61">ğŸ‡¦ğŸ‡º +61</option>
                <option value="+81">ğŸ‡¯ğŸ‡µ +81</option>
                <option value="+86">ğŸ‡¨ğŸ‡³ +86</option>
                <option value="+49">ğŸ‡©ğŸ‡ª +49</option>
                <option value="+33">ğŸ‡«ğŸ‡· +33</option>
                <option value="+971">ğŸ‡¦ğŸ‡ª +971</option>
                <option value="+65">ğŸ‡¸ğŸ‡¬ +65</option>
              </select>
              <input id="ds-phone" type="tel" placeholder="XXXXXXXXXX (optional)" style="flex:1;">
            </div>
          </div>
          <div class="field">
            <label>Clinic / Location</label>
            <div id="ds-location-container" style="position:relative;">
              <input id="ds-location" type="text" placeholder="e.g., Apollo Hospital, Tardeo, Mumbai" style="width:100%; box-sizing:border-box;">
            </div>
            <div id="clinic-map-preview" style="display:none; margin-top:12px; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,0.1);">
              <iframe id="clinic-map-iframe" width="100%" height="200" style="border:0" loading="lazy" allowfullscreen="" src=""></iframe>
            </div>
          </div>
          <div style="padding:8px; font-size:11px; color:rgba(255,255,255,0.4); margin-top:-8px;">
            ğŸ’¡ Tip: Start typing a clinic name to see suggestions with embedded map preview.
          </div>

          <div style="display:flex;gap:8px;justify-content:center;margin-top:8px;">
            <button type="button" class="btn primary" id="ds-create">Create & Enter</button>
            <button type="button" class="btn ghost" id="ds-back">Back</button>
          </div>

          <div id="ds-error" class="error-text" style="display:none"></div>
        </div>
      </section>

      <!-- Doctor login -->
      <section id="page-doctor-login" class="page">
        <div class="center" style="gap:10px;">
          <h2>Doctor â€” Sign in</h2>
          <p class="tiny">Use your username and password (demo: localStorage)</p>
        </div>

        <div style="margin-top:12px; max-width:520px; margin-left:auto; margin-right:auto; display:flex; flex-direction:column; align-items:center;">
          <div class="field" style="width:100%; max-width:300px;"><label>Username <input id="dl-username" type="text" placeholder="username"></label></div>
          <div class="field" style="width:100%; max-width:300px;"><label>Password <input id="dl-password" type="password" placeholder="password"></label></div>

          <div style="display:flex;gap:8px;justify-content:center;margin-top:8px;">
            <button type="button" class="btn primary" id="dl-login">Sign in</button>
            <button type="button" class="btn ghost" id="dl-back">Back</button>
          </div>

          <div id="dl-error" class="error-text" style="display:none;"></div>

          <div style="margin-top:12px; width:100%; max-width:300px;">
            <div id="g_id_onload"
              data-client_id="581250268164-0s2b0psiu4doetheepdjaoti79s338jm.apps.googleusercontent.com"
              data-callback="handleGoogleSignIn">
            </div>
            <div class="g_id_signin" data-type="standard"></div>
          </div>

          <p class="tiny" style="margin-top:10px; text-align:center">
            New? <button type="button" class="btn ghost" id="dl-goto-signup" style="padding:6px 10px;">Create doctor account</button>
          </p>
        </div>
      </section>

      <!-- Main Symptom (kept but patient now directed from dashboard) -->
      <section id="page-main-symptom" class="page">
        <div style="text-align:center;"><h2>Main Symptom</h2><p class="tiny">Type main symptom (fever, chest pain, rash)</p></div>
        <div style="margin-top:12px;">
          <div class="field"><input id="main-sym" type="text" placeholder="e.g., chest pain"></div>
          <div style="display:flex;gap:8px;justify-content:center">
            <button class="btn primary" id="sym-next" disabled>Next â€” Start 10 MCQs</button>
            <button class="btn ghost" id="sym-back">Back</button>
          </div>
        </div>
      </section>

      <!-- Test -->
      <section id="page-test" class="page">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h2>Quick Test</h2><div class="tiny">10 questions</div></div>
          <div class="tiny">Progress: <span id="test-progress-text">0/10</span></div>
        </div>
        <div style="margin-top:12px;">
          <div class="progress" style="background: rgba(255,255,255,0.03); height:10px; border-radius:8px; overflow:hidden;">
            <i id="test-progress-bar" style="display:block;height:10px;background:linear-gradient(90deg,var(--accent1),var(--accent2));border-radius:8px;width:0%;"></i>
          </div>
          <div class="q-card card" id="q-card" aria-live="polite"></div>
          <div style="display:flex;justify-content:space-between;gap:12px;margin-top:12px;">
            <button class="btn ghost" id="q-prev">â—€ Prev</button>
            <div style="display:flex;gap:8px">
              <button class="btn" id="q-save">Save & Exit</button>
              <button class="btn primary" id="q-next">Next â–¶</button>
            </div>
          </div>
        </div>
        <!-- Local alert modal for MCQ validation -->
        <div id="mcq-alert" class="alert-overlay" style="display:none;">
          <div class="alert-box">
            <p>Please select an option</p>
            <button id="mcq-alert-ok" class="btn primary">OK</button>
          </div>
        </div>

        <!-- Doctor Quick-View Modal -->
        <div id="doctor-quick-modal" class="doctor-quick-modal-overlay" style="display:none;">
          <div class="doctor-quick-modal">
            <div class="doctor-quick-modal-header">
              <div class="doctor-quick-modal-avatar" id="dqm-avatar"></div>
              <div class="doctor-quick-modal-title">
                <h3 id="dqm-name"></h3>
                <span class="specialty-badge" id="dqm-specialty"></span>
              </div>
              <button class="doctor-quick-modal-close" id="dqm-close" aria-label="Close">&times;</button>
            </div>
            <div class="doctor-quick-modal-body">
              <!-- Map Preview Section -->
              <div class="doctor-quick-modal-section">
                <h4>ğŸ“ Location</h4>
                <div id="dqm-map-container"></div>
              </div>
              
              <!-- Clinic Details Section -->
              <div class="doctor-quick-modal-section">
                <h4>ğŸ¥ Clinic Details</h4>
                <div class="doctor-quick-clinic-details">
                  <div class="doctor-quick-detail-row">
                    <span class="icon">ğŸ“</span>
                    <div class="content">
                      <div class="label">Address</div>
                      <div class="value" id="dqm-address"></div>
                    </div>
                  </div>
                  <div class="doctor-quick-detail-row">
                    <span class="icon">ğŸ“</span>
                    <div class="content">
                      <div class="label">Phone</div>
                      <div class="value"><a id="dqm-phone" href="#"></a></div>
                    </div>
                  </div>
                  <div class="doctor-quick-detail-row" id="dqm-distance-row" style="display:none;">
                    <span class="icon">ğŸš—</span>
                    <div class="content">
                      <div class="label">Distance</div>
                      <div class="value" id="dqm-distance"></div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Booking Form Section -->
              <div class="doctor-quick-modal-section">
                <h4>ğŸ“… Book Appointment</h4>
                <div class="doctor-quick-booking-form">
                  <div class="field">
                    <label for="dqm-mode" style="font-size:13px;color:var(--muted);font-weight:600;">Visit Mode</label>
                    <select id="dqm-mode" required>
                      <option value="in_person">In-Person Visit</option>
                      <option value="video">Video Consultation</option>
                      <option value="phone">Phone Call</option>
                    </select>
                  </div>
                  <div class="doctor-quick-form-row">
                    <div class="field">
                      <label for="dqm-date" style="font-size:13px;color:var(--muted);font-weight:600;">Date</label>
                      <input type="date" id="dqm-date" required />
                    </div>
                    <div class="field">
                      <label for="dqm-time" style="font-size:13px;color:var(--muted);font-weight:600;">Time</label>
                      <input type="time" id="dqm-time" required />
                    </div>
                  </div>
                  <div class="field">
                    <label for="dqm-notes" style="font-size:13px;color:var(--muted);font-weight:600;">Notes (optional)</label>
                    <textarea id="dqm-notes" placeholder="Any specific concerns or requirements..." rows="3"></textarea>
                  </div>
                </div>
                <div id="dqm-error" class="doctor-quick-error" style="display:none;"></div>
              </div>
            </div>
            <div class="doctor-quick-modal-footer">
              <button class="btn ghost" id="dqm-cancel">Cancel</button>
              <button class="btn primary" id="dqm-book">Book Appointment</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Suggestion -->
      <section id="page-suggest" class="page">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h2>Suggested Specialty: <span id="suggest-specialty" style="color:#b6aaff;font-weight:800"></span></h2><div class="tiny" id="suggest-sub">Based on your answers</div></div>
          <div class="tiny">Severity: <strong id="suggest-confidence">High</strong></div>
        </div>

        <div class="doctor-list" id="doctor-list" style="margin-top:12px"></div>

        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
          <button class="btn primary" id="send-request">Send Request (general)</button>
          <button class="btn ghost" id="suggest-back">Back</button>
        </div>
      </section>

      <!-- DOCTOR DASHBOARD (new page appended) -->
      <section id="page-doctor-dashboard" class="page dash-page" aria-hidden="true">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2>Doctor Dashboard</h2>
            <div class="tiny" id="doctor-welcome">Welcome, Doctor</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button type="button" class="btn ghost" id="doctor-back">Back</button>
            <button type="button" class="btn ghost" id="doctor-logout">Logout</button>
          </div>
        </div>

        <div class="dashboard">
          <div>
            <div class="panel">
              <div class="kpis">
                <div class="kpi"><h3>Pending requests</h3><div id="kpi-pending" class="num">0</div></div>
                <div class="kpi"><h3>Today's appts</h3><div id="kpi-today" class="num">0</div></div>
                <div class="kpi"><h3>Unresolved</h3><div id="kpi-unresolved" class="num">0</div></div>
              </div>
            </div>

            <div class="panel" style="margin-top:12px;">
              <h3 style="margin:0 0 8px 0">Incoming Requests</h3>
              <div class="requests-list" id="requests-list"></div>
            </div>
          </div>

          <div>
            <div class="panel">
              <h3 style="margin:0 0 8px 0">Today's Appointments</h3>
              <div class="appt-list" id="appt-list"></div>
            </div>

            <div class="panel" style="margin-top:12px;">
              <h3 style="margin:0 0 8px 0">Quick Actions</h3>
              <div style="display:flex;flex-direction:column;gap:8px">
                <button type="button" class="btn primary" id="toggle-online">Go Offline</button>
                <button type="button" class="btn ghost" id="edit-profile-btn">Edit Profile</button>
                <button type="button" class="btn ghost" id="refresh-dashboard">Refresh</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Doctor Edit Profile Page -->
      <section id="page-doctor-edit-profile" class="page">
        <div class="center" style="gap:20px; width:100%; max-width:500px; margin:0 auto;">
          <h2>Edit Profile</h2>
          <p class="tiny">Update your professional information</p>

          <!-- Profile Photo Section -->
          <div style="text-align:center; width:100%;">
            <div id="ep-photo-preview" style="width:120px; height:120px; margin:0 auto 12px; border-radius:50%; background:#1a3a52; display:flex;align-items:center;justify-content:center; border:2px solid rgba(255,255,255,0.1); font-size:40px; overflow:hidden;">
              ğŸ“·
            </div>
            <label style="cursor:pointer;">
              <input type="file" id="ep-photo-input" accept="image/*" style="display:none;">
              <span class="btn ghost" style="display:inline-block; padding:6px 12px; font-size:13px;">Change Photo</span>
            </label>
            <div class="tiny" style="color:var(--muted); margin-top:6px;">JPG, PNG (max 5MB)</div>
          </div>

          <!-- Form Fields -->
          <div style="width:100%;">
            <div class="field"><label>Full name <input id="ep-name" type="text" placeholder="e.g., Dr. Arup Sen" style="width:100%;"></label></div>
            <div class="field"><label>Specialty 
              <select id="ep-specialty" required style="width:100%;">
                <option value="">-- Select Specialty --</option>
                <option value="Cardiology">Cardiology</option>
                <option value="Dermatology">Dermatology</option>
                <option value="Endocrinology">Endocrinology</option>
                <option value="ENT">ENT (Ear, Nose, Throat)</option>
                <option value="Gastroenterology">Gastroenterology</option>
                <option value="General Practice">General Practice</option>
                <option value="Hematology">Hematology</option>
                <option value="Nephrology">Nephrology</option>
                <option value="Neurology">Neurology</option>
                <option value="Oncology">Oncology</option>
                <option value="Ophthalmology">Ophthalmology</option>
                <option value="Orthopedics">Orthopedics</option>
                <option value="Pediatrics">Pediatrics</option>
                <option value="Psychiatry">Psychiatry</option>
                <option value="Pulmonology">Pulmonology</option>
                <option value="Rheumatology">Rheumatology</option>
                <option value="Urology">Urology</option>
              </select>
            </label></div>
            <div class="field">
              <label>Phone</label>
              <div style="display:flex;gap:8px;">
                <select id="ep-country-code" style="width:120px;">
                  <option value="+91">ğŸ‡®ğŸ‡³ +91</option>
                  <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
                  <option value="+44">ğŸ‡¬ğŸ‡§ +44</option>
                  <option value="+61">ğŸ‡¦ğŸ‡º +61</option>
                  <option value="+81">ğŸ‡¯ğŸ‡µ +81</option>
                  <option value="+86">ğŸ‡¨ğŸ‡³ +86</option>
                  <option value="+49">ğŸ‡©ğŸ‡ª +49</option>
                  <option value="+33">ğŸ‡«ğŸ‡· +33</option>
                  <option value="+971">ğŸ‡¦ğŸ‡ª +971</option>
                  <option value="+65">ğŸ‡¸ğŸ‡¬ +65</option>
                </select>
                <input id="ep-phone" type="tel" placeholder="XXXXXXXXXX" style="flex:1;">
              </div>
            </div>
            <div class="field">
              <label>Clinic / Location</label>
              <div id="ep-location-container" style="position:relative;">
                <input id="ep-location" type="text" placeholder="e.g., Apollo Hospital, Tardeo, Mumbai" style="width:100%; box-sizing:border-box;">
              </div>
              <div id="ep-clinic-map-preview" style="display:none; margin-top:12px; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,0.1);">
                <iframe id="ep-clinic-map-iframe" width="100%" height="200" style="border:0" loading="lazy" allowfullscreen="" src=""></iframe>
              </div>
            </div>
            <div class="field"><label>Password (leave blank to keep current) <input id="ep-password" type="password" placeholder="new password (min 6 chars)" style="width:100%;"></label></div>

            <div style="display:flex;gap:8px;justify-content:center;margin-top:12px; width:100%;">
              <button type="button" class="btn primary" id="ep-save">Save Changes</button>
              <button type="button" class="btn ghost" id="ep-cancel">Cancel</button>
            </div>

            <div id="ep-error" class="error-text" style="display:none; width:100%;"></div>
            <div id="ep-success" class="success-text" style="display:none; width:100%;"></div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <!-- Custom Confirmation Modal -->
  <div id="confirm-modal" class="modal-backdrop" style="display:none">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="confirm-title">Confirm Action</h3>
      <p id="confirm-message" class="tiny" style="margin-top:8px; margin-bottom:16px;"></p>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button type="button" class="btn ghost" id="confirm-cancel-btn">Cancel</button>
        <button type="button" class="btn primary" id="confirm-ok-btn">OK</button>
      </div>
    </div>
  </div>

  <!-- Health blog modal -->
  <div id="blog-modal" class="modal-backdrop" style="display:none">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="blogTitle">
      <h3 id="blogTitle">Health Blog â€” Quick Advice</h3>
      <p class="tiny" style="margin-top:6px">Type your main problem (e.g., fever, rash, chest pain) and get immediate home suggestions.</p>
      <div style="margin-top:10px">
        <div class="field"><label>Problem <input id="blog-problem" type="text" placeholder="e.g., fever and headache"></label></div>
        <div style="display:flex;gap:8px;align-items:center;"><button class="btn primary" id="blog-submit">Get Suggestion</button><button class="btn ghost" id="blog-cancel">Close</button></div>
        <div id="blog-result" class="tiny" style="margin-top:12px;color:var(--muted)"></div>
      </div>
    </div>
  </div>

  <!-- Request modal for doctor (reused hidden modal) -->
  <div id="req-modal" class="modal-backdrop" style="display:none">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="req-title">Request</h3>
      <div id="req-meta" class="tiny" style="margin-top:6px"></div>
      <div id="req-body" style="margin-top:10px"></div>
      <div id="req-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn ghost" id="req-reject">Reject</button>
        <button class="btn primary" id="req-accept">Accept & Book</button>
      </div>

      <!-- Book Appointment Form (AC1: Pre-filled, editable) -->
      <div id="req-book-form" style="display:none;margin-top:12px">
        <h4 style="margin:0 0 12px 0">ğŸ“… Book Appointment</h4>
        
        <!-- Date/Time selection -->
        <div class="field" style="margin-bottom:12px">
          <label style="font-size:12px;font-weight:600;color:var(--muted)">Start Date & Time (UTC)</label>
          <div style="display:flex;gap:8px;margin-top:4px">
            <input id="book-date" type="date" style="flex:1">
            <input id="book-time" type="time" style="flex:1">
          </div>
        </div>

        <!-- End time -->
        <div class="field" style="margin-bottom:12px">
          <label style="font-size:12px;font-weight:600;color:var(--muted)">End Time (UTC)</label>
          <input id="book-end-time" type="time" style="width:100%;margin-top:4px">
        </div>

        <!-- Mode selection -->
        <div class="field" style="margin-bottom:12px">
          <label style="font-size:12px;font-weight:600;color:var(--muted)">Appointment Mode</label>
          <select id="book-mode" style="width:100%;margin-top:4px">
            <option value="video">Video Call</option>
            <option value="in_person">In Person</option>
            <option value="phone">Phone Call</option>
          </select>
        </div>

        <!-- Notes -->
        <div class="field" style="margin-bottom:12px">
          <label style="font-size:12px;font-weight:600;color:var(--muted)">Notes (Optional)</label>
          <textarea id="book-notes" placeholder="e.g., Follow-up on previous consultation" style="width:100%;margin-top:4px;min-height:60px"></textarea>
        </div>

        <!-- Error message -->
        <div id="book-error" class="error-text" style="margin-bottom:12px;display:none"></div>

        <!-- Action buttons -->
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button type="button" class="btn ghost" id="book-cancel">Cancel</button>
          <button type="button" class="btn primary" id="book-confirm" disabled>Confirm Booking</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Health Assistant AI Chatbot -->
  <div id="chat-btn-float" class="chat-btn-float" title="Open Health Assistant AI">ğŸ¤–</div>

  <div id="chat-window" class="chat-window">
    <div class="chat-header">
      <div class="chat-title">
        <span style="font-size:18px;">ğŸ¤–</span> Health Assistant AI
      </div>
      <button id="chat-close" style="background:none; border:none; color:var(--muted); cursor:pointer; font-size:18px;">âœ•</button>
    </div>
    
    <div class="chat-body" id="chat-body">
      <div class="chat-msg bot">Hello! I am your AI Health Assistant. Describe your symptoms (e.g., "fever", "chest pain") and I'll give you quick home tips.</div>
    </div>
    
    <div class="chat-footer">
      <input type="text" id="chat-input" placeholder="Type here...">
      <button id="chat-send" style="padding:8px 12px; border-radius:20px; font-weight:bold; transition:transform 0.2s;" type="button">â†’</button>
    </div>
  </div>

  <!-- New Booking Modal -->
  <div id="booking-modal" class="booking-modal-overlay" style="display:none;">
    <div class="booking-modal">
      <div class="booking-modal-header">
        <div class="booking-modal-header-content">
          <h3 id="bm-doctor-name">Dr. Name</h3>
          <span class="booking-modal-specialty" id="bm-specialty">Specialty</span>
          <div class="booking-modal-address">
            <span>ğŸ“</span>
            <span id="bm-address">Clinic Address</span>
          </div>
        </div>
        <button class="booking-modal-close" id="bm-close" aria-label="Close">&times;</button>
      </div>
      
      <div class="booking-modal-body">
        <!-- Map Section -->
        <div class="booking-modal-section">
          <h4>ğŸ“ Location</h4>
          <div class="booking-map-container" id="bm-map-container">
            <iframe id="bm-map-iframe" src="" allowfullscreen="" loading="lazy"></iframe>
          </div>
        </div>

        <!-- Booking Form -->
        <div class="booking-modal-section">
          <h4>ğŸ“… Appointment Details</h4>
          <div class="booking-form-group">
            <div class="field">
              <label for="bm-mode" style="font-size:13px;color:var(--muted);font-weight:600;">Visit Mode</label>
              <select id="bm-mode" required>
                <option value="in_person">In-Person Visit</option>
                <option value="video">Video Consultation</option>
                <option value="phone">Phone Call</option>
              </select>
            </div>
            
            <div class="booking-form-row">
              <div class="field">
                <label for="bm-date" style="font-size:13px;color:var(--muted);font-weight:600;">Date</label>
                <input type="date" id="bm-date" required />
              </div>
              <div class="field">
                <label for="bm-time" style="font-size:13px;color:var(--muted);font-weight:600;">Time</label>
                <input type="time" id="bm-time" required />
              </div>
            </div>
            
            <div class="field">
              <label for="bm-notes" style="font-size:13px;color:var(--muted);font-weight:600;">Notes (optional)</label>
              <textarea id="bm-notes" placeholder="Any specific concerns or requirements..." rows="3"></textarea>
            </div>
          </div>
          
          <div id="bm-error" class="booking-error" style="display:none;"></div>
        </div>
      </div>
      
      <div class="booking-modal-footer">
        <button class="btn ghost" id="bm-cancel">Cancel</button>
        <button class="btn primary" id="bm-book">Book Appointment</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Storage helpers ---------- */
const USERS_KEY = 'st_users', REQS_KEY = 'st_requests', APPTS_KEY = 'st_appts', TIMELINE_KEY = 'st_timeline', SUB_KEY = 'st_subscription';
function load(k){ try{ return JSON.parse(localStorage.getItem(k)||'null'); }catch(e){return null;} }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
if(!load(USERS_KEY)) save(USERS_KEY, []);
if(!load(REQS_KEY)) save(REQS_KEY, []);
if(!load(APPTS_KEY)) save(APPTS_KEY, []);

/* ---------- Theme restore ---------- */
(function(){
  const t = localStorage.getItem('st_theme') || 'dark';
  if(t === 'light') document.documentElement.classList.add('light-mode');
  updateThemeButton();
})();
function updateThemeButton(){
  const btn = document.getElementById('ctrl-theme');
  if(!btn) return;
  const isLight = document.documentElement.classList.contains('light-mode');
  btn.textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
  btn.title = isLight ? 'Switch to dark mode' : 'Switch to light mode';
}

/* ---------- Top controls ---------- */
document.getElementById('ctrl-theme').addEventListener('click', ()=> {
  const isLight = document.documentElement.classList.toggle('light-mode');
  localStorage.setItem('st_theme', isLight ? 'light' : 'dark');
  updateThemeButton();
});
document.getElementById('landing-blog-mini')?.addEventListener('click', ()=> openBlog());
document.getElementById('ctrl-sub').addEventListener('click', ()=> { openSubscriptionPage(); });
document.getElementById('landing-sub-mini')?.addEventListener('click', ()=> { openSubscriptionPage(); });

/* ---------- Avatar / profile click ---------- */
document.getElementById('ctrl-profile').addEventListener('click', ()=> {
  const sess = JSON.parse(sessionStorage.getItem('st_session')||'null');
  if(sess && sess.role === 'doctor'){
    renderDoctorDashboard(); // open dashboard if signed in as doctor
  } else {
    showPage('page-doctor-login');
  }
});

/* landing doctor mini also opens doctor login */
document.getElementById('landing-doctor-mini')?.addEventListener('click', ()=> showPage('page-doctor-login'));

/* ---------- Blog modal ---------- */
const blogModal = document.getElementById('blog-modal'), blogProblem = document.getElementById('blog-problem'), blogResult = document.getElementById('blog-result');
document.getElementById('blog-cancel').addEventListener('click', closeBlogModal);
document.getElementById('blog-submit').addEventListener('click', handleBlogSubmit);

function openBlog(){ blogProblem.value=''; blogResult.textContent=''; blogModal.style.display='flex'; setTimeout(()=>blogProblem.focus(),80); }
function closeBlogModal(){ blogModal.style.display='none'; blogResult.textContent=''; }

function handleBlogSubmit(){
  const txt = (blogProblem.value||'').trim().toLowerCase();
  if(!txt){ blogResult.textContent = 'Please type your problem.'; return; }
  let suggestion = '';
  if(/fever|temperature|febr|hot/.test(txt)){
    suggestion = "Home tips: rest, increase fluids, paracetamol if >38Â°C (follow dosing), cool compress to forehead. If breathlessness, persistent high fever, confusion â†’ see a doctor.";
  } else if(/chest|pain|angina|tighten|pressure|breath/.test(txt)){
    suggestion = "Warning: chest pain can be serious. Sit down, avoid exertion. If severe/worsening/shortness of breath or sweating/fainting â†’ seek emergency care immediately.";
  } else if(/rash|itch|skin|eczema|red/.test(txt)){
    suggestion = "Home tips: avoid scratching, gentle cleansers, cool compress, calamine for itching, keep area clean. If spreading rapidly, blistering, fever â†’ see dermatologist.";
  } else if(/back|joint|pain|sprain|fracture/.test(txt)){
    suggestion = "Home tips: rest, ice for first 48 hours for sprain, elevation if swelling, avoid heavy lifting. If deformity, inability to move/weight-bear â†’ see orthopedics.";
  } else {
    suggestion = "General advice: rest, hydration, monitor symptoms. If symptoms are severe (breathing difficulty, heavy bleeding, fainting, sudden severe pain) seek medical care.";
  }
  blogResult.innerHTML = `<div style="margin-bottom:8px">${suggestion}</div>`;
}

/* ---------- Subscription page ---------- */
function getCurrentPlan(){
  const stored = load(SUB_KEY) || null;
  return stored?.plan || 'Basic';
}

function subscribePlan(plan){
  const prices = { 'Basic': 'Free', 'Gold Member': 'â‚¹199/mo', 'Family Shield': 'â‚¹499/mo' };
  save(SUB_KEY, { plan, price: prices[plan] || 'Free', since: new Date().toISOString() });
  showToast(`Subscribed to ${plan}!`);
  renderSubscriptionPage();
}

function renderSubscriptionPage(){
  const plan = getCurrentPlan();
  const basicBtn = document.getElementById('sub-basic-btn');
  const goldBtn = document.getElementById('sub-gold-btn');
  const familyBtn = document.getElementById('sub-family-btn');

  if(basicBtn){
    basicBtn.textContent = plan === 'Basic' ? 'Current Plan' : 'Switch to Basic';
    basicBtn.disabled = plan === 'Basic';
  }
  if(goldBtn){
    goldBtn.textContent = plan === 'Gold Member' ? 'Current Plan' : 'Upgrade to Gold';
    goldBtn.disabled = plan === 'Gold Member';
  }
  if(familyBtn){
    familyBtn.textContent = plan === 'Family Shield' ? 'Current Plan' : 'Upgrade to Family';
    familyBtn.disabled = plan === 'Family Shield';
  }
}

function openSubscriptionPage(){
  renderSubscriptionPage();
  showPage('page-subscription');
}

function goBackFromSub(){
  const sess = JSON.parse(sessionStorage.getItem('st_session')||'null');
  if(sess && sess.role === 'patient') {
    renderPatientDashboard();
    showPage('page-patient-dashboard');
  } else {
    showPage('page-landing');
  }
}

/* ---------- Pages & navigation ---------- */
const pages = {
  'page-landing': document.getElementById('page-landing'),
  'page-patient-signup': document.getElementById('page-patient-signup'),
  'page-patient-login': document.getElementById('page-patient-login'),
  'page-doctor-signup': document.getElementById('page-doctor-signup'),
  'page-doctor-login': document.getElementById('page-doctor-login'),
  'page-main-symptom': document.getElementById('page-main-symptom'),
  'page-test': document.getElementById('page-test'),
  'page-suggest': document.getElementById('page-suggest'),
  'page-doctor-dashboard': document.getElementById('page-doctor-dashboard'),
  'page-patient-dashboard': document.getElementById('page-patient-dashboard'),
  'page-patient-edit-profile': document.getElementById('page-patient-edit-profile'),
  'page-subscription': document.getElementById('page-subscription'),
  'page-doctor-edit-profile': document.getElementById('page-doctor-edit-profile')
};
function showPage(id){
  Object.values(pages).forEach(p=>p && p.classList && p.classList.remove('active'));
  if(pages[id]) pages[id].classList.add('active');
}

/* Landing -> patient signup */
document.getElementById('btn-patient').addEventListener('click', ()=> showPage('page-patient-signup'));

/* ---------- Patient signup ---------- */
const psName = document.getElementById('ps-name'), psUsername = document.getElementById('ps-username'), psPassword = document.getElementById('ps-password'), psCreate = document.getElementById('ps-create'), psBack = document.getElementById('ps-back'), psError = document.getElementById('ps-error');
psBack.addEventListener('click', ()=> { psError.style.display='none'; showPage('page-landing'); });
const psGotoLogin = document.getElementById('ps-goto-login');
if(psGotoLogin) psGotoLogin.addEventListener('click', ()=> { psError.style.display='none'; showPage('page-patient-login'); });

psCreate.addEventListener('click', ()=> {
  psError.style.display='none';
  const name = psName.value.trim(), username = psUsername.value.trim(), password = psPassword.value;
  if(!name) return showError(psError,'Please enter full name.');
  let uname = username || name.toLowerCase().replace(/\s+/g, '.').replace(/[^a-z0-9._-]/g,'');
  if(!/^[a-zA-Z0-9._-]{3,}$/.test(uname)) return showError(psError,'Username must be >=3 chars (letters/digits . _ -).');
  if(!password) return showError(psError,'Please enter password.');
  if(password.length < 6) return showError(psError,'Password must be >=6 chars.');
  const users = load(USERS_KEY) || [];
  let unameFinal = uname; let suffix = 1;
  while(users.find(u=> u.username === unameFinal)){ unameFinal = uname + suffix; suffix++; }
  users.push({ username: unameFinal, password, role:'patient', name, age:'â€”', gender:'â€”', lastCheckup:'â€”' });
  save(USERS_KEY, users);
  sessionStorage.setItem('st_session', JSON.stringify({ username: unameFinal, role:'patient' }));
  psName.value=''; psUsername.value=''; psPassword.value='';
  // Open patient dashboard after signup:
  renderPatientDashboard();
});

/* ---------- Patient login ---------- */
const plUsername = document.getElementById('pl-username'), plPassword = document.getElementById('pl-password'), plLogin = document.getElementById('pl-login'), plBack = document.getElementById('pl-back'), plError = document.getElementById('pl-error');
if(plBack) plBack.addEventListener('click', ()=> { plError.style.display='none'; showPage('page-patient-signup'); });
if(plLogin) plLogin.addEventListener('click', ()=> {
  plError.style.display = 'none';
  const username = (plUsername.value||'').trim();
  const password = plPassword.value||'';
  if(!username) return showError(plError, 'Please enter username.');
  if(!password) return showError(plError, 'Please enter password.');
  const users = load(USERS_KEY) || [];
  const patient = users.find(u => u.role === 'patient' && u.username === username);
  if(!patient) return showError(plError, 'No patient found with that username.');
  if(patient.password !== password) return showError(plError, 'Incorrect password.');
  sessionStorage.setItem('st_session', JSON.stringify({ username: patient.username, role: 'patient' }));
  showToast('Signed in as ' + (patient.name || patient.username));
  plUsername.value = ''; plPassword.value = '';
  renderPatientDashboard();
});

/* ---------- Doctor signup ---------- */
const dsName = document.getElementById('ds-name'), dsUsername = document.getElementById('ds-username'), dsPassword = document.getElementById('ds-password'), dsSpecialty = document.getElementById('ds-specialty'), dsPhone = document.getElementById('ds-phone'), dsLocation = document.getElementById('ds-location'), dsCreate = document.getElementById('ds-create'), dsBack = document.getElementById('ds-back'), dsError = document.getElementById('ds-error');

// Clinic Location Autocomplete with Google Maps Embed iframe
let selectedPlace = null;

// Demo clinic dataset for autocomplete (no API needed)
const DEMO_CLINICS = [
  { name: 'Apollo Hospital, Mumbai', address: 'Mumbai, Maharashtra', lat: 19.0760, lng: 72.8777, query: 'Apollo Hospital Mumbai' },
  { name: 'Apollo Hospital, Delhi', address: 'Delhi', lat: 28.5724, lng: 77.2065, query: 'Apollo Hospital Delhi' },
  { name: 'Apollo Hospital, Bangalore', address: 'Bangalore, Karnataka', lat: 13.1939, lng: 77.6045, query: 'Apollo Hospital Bangalore' },
  { name: 'Fortis Healthcare, Mumbai', address: 'Mumbai, Maharashtra', lat: 19.0176, lng: 72.8479, query: 'Fortis Healthcare Mumbai' },
  { name: 'Fortis Healthcare, Delhi', address: 'Delhi', lat: 28.5355, lng: 77.3910, query: 'Fortis Healthcare Delhi' },
  { name: 'Max Healthcare, Delhi', address: 'Delhi', lat: 28.5244, lng: 77.1855, query: 'Max Healthcare Delhi' },
  { name: 'Max Healthcare, Mumbai', address: 'Mumbai, Maharashtra', lat: 19.1136, lng: 72.8697, query: 'Max Healthcare Mumbai' },
  { name: 'Lilavati Hospital, Mumbai', address: 'Mumbai, Maharashtra', lat: 19.0288, lng: 72.8281, query: 'Lilavati Hospital Mumbai' },
  { name: 'Sir Ganga Ram Hospital, Delhi', address: 'Delhi', lat: 28.7041, lng: 77.2064, query: 'Sir Ganga Ram Hospital Delhi' },
  { name: 'Breach Candy Hospital, Mumbai', address: 'Mumbai, Maharashtra', lat: 18.9676, lng: 72.8194, query: 'Breach Candy Hospital Mumbai' },
  { name: 'Kokilaben Hospital, Mumbai', address: 'Mumbai, Maharashtra', lat: 19.1356, lng: 72.8900, query: 'Kokilaben Hospital Mumbai' },
  { name: 'Holy Family Hospital, Delhi', address: 'Delhi', lat: 28.6328, lng: 77.2197, query: 'Holy Family Hospital Delhi' },
];

function createAutocompleteDropdown() {
  const container = document.getElementById('ds-location-container');
  const existingDropdown = document.getElementById('clinic-suggestions-dropdown');
  if (existingDropdown) existingDropdown.remove();
  
  const dropdown = document.createElement('div');
  dropdown.id = 'clinic-suggestions-dropdown';
  dropdown.style.cssText = `
    position: absolute; top: 100%; left: 0; right: 0; background: #0f1724; border: 1px solid rgba(255,255,255,0.1); 
    border-top: none; border-radius: 0 0 12px 12px; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; margin-top: -2px;
  `;
  container.appendChild(dropdown);
  return dropdown;
}

function showSuggestions(query, dropdown) {
  if (!query.trim()) {
    dropdown.style.display = 'none';
    return;
  }
  
  const filtered = DEMO_CLINICS.filter(clinic => 
    clinic.name.toLowerCase().includes(query.toLowerCase()) ||
    clinic.address.toLowerCase().includes(query.toLowerCase())
  );
  
  if (filtered.length === 0) {
    dropdown.style.display = 'none';
    return;
  }
  
  dropdown.innerHTML = filtered.map(clinic => `
    <div class="clinic-suggestion" data-clinic='${JSON.stringify(clinic).replace(/'/g, "&apos;")}' 
         style="padding: 10px 14px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); color: #e6eef8; font-size: 13px;">
      <div style="font-weight: 500;">${clinic.name}</div>
      <div style="font-size: 11px; color: var(--muted);">${clinic.address}</div>
    </div>
  `).join('');
  
  dropdown.style.display = 'block';
  
  dropdown.querySelectorAll('.clinic-suggestion').forEach(item => {
    item.addEventListener('click', () => {
      const clinic = JSON.parse(item.getAttribute('data-clinic'));
      selectClinic(clinic);
      dropdown.style.display = 'none';
    });
    item.addEventListener('mouseover', () => {
      item.style.backgroundColor = 'rgba(123,97,255,0.2)';
    });
    item.addEventListener('mouseout', () => {
      item.style.backgroundColor = 'transparent';
    });
  });
}

function selectClinic(clinic) {
  selectedPlace = clinic;
  
  dsLocation.value = clinic.name;
  
  // Show map iframe using lat/lng
  const mapPreview = document.getElementById('clinic-map-preview');
  const mapIframe = document.getElementById('clinic-map-iframe');
  mapPreview.style.display = 'block';
  
  // Google Maps embed using coordinates
  mapIframe.src = `https://www.google.com/maps?q=${clinic.lat},${clinic.lng}&output=embed`;
}

// Live Map Preview - shows map as user types
let mapTimeout = null;
function initializeLiveMapPreview() {
  const dsLoc = document.getElementById('ds-location');
  const dsMap = document.getElementById('clinic-map-preview');
  
  dsLoc.addEventListener('input', () => {
    const val = dsLoc.value.trim();
    
    // If input is empty, hide the map
    if(!val) { 
      dsMap.style.display = 'none'; 
      return; 
    }
    
    // Debounce: update map 1 second after user stops typing
    clearTimeout(mapTimeout);
    mapTimeout = setTimeout(() => {
      dsMap.style.display = 'block';
      
      // Load Google Maps iframe with the location query
      dsMap.innerHTML = `
        <iframe 
          width="100%" 
          height="100%" 
          style="border:0" 
          loading="lazy" 
          src="https://www.google.com/maps?q=${encodeURIComponent(val)}&output=embed">
        </iframe>`;
    }, 1000);
  });
}

function initializeClinicAutocomplete() {
  const dropdown = createAutocompleteDropdown();
  
  dsLocation.addEventListener('input', () => {
    showSuggestions(dsLocation.value, dropdown);
  });
  
  dsLocation.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') e.preventDefault();
    if (e.key === 'Escape') dropdown.style.display = 'none';
  });
  
  document.addEventListener('click', (e) => {
    if (e.target !== dsLocation && e.target.id !== 'clinic-suggestions-dropdown') {
      dropdown.style.display = 'none';
    }
  });
}

// Initialize autocomplete and live map preview
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      initializeClinicAutocomplete();
      initializeLiveMapPreview();
    }, 300);
  });
} else {
  setTimeout(() => {
    initializeClinicAutocomplete();
    initializeLiveMapPreview();
  }, 300);
}

dsBack.addEventListener('click', ()=> { dsError.style.display='none'; showPage('page-landing'); });

// Validate coordinates if provided
function validateCoordinates(lat, lng) {
  if (!lat && !lng) return { valid: true }; // Both optional
  
  if ((lat && !lng) || (!lat && lng)) {
    return { valid: false, error: 'Please provide both latitude and longitude, or leave both empty.' };
  }
  
  const latNum = parseFloat(lat);
  const lngNum = parseFloat(lng);
  
  if (isNaN(latNum) || isNaN(lngNum)) {
    return { valid: false, error: 'Latitude and longitude must be valid numbers.' };
  }
  
  if (latNum < -90 || latNum > 90) {
    return { valid: false, error: 'Latitude must be between -90 and 90.' };
  }
  
  if (lngNum < -180 || lngNum > 180) {
    return { valid: false, error: 'Longitude must be between -180 and 180.' };
  }
  
  return { valid: true, lat: latNum, lng: lngNum };
}

// Auto-generate username from name with 3 format attempts + random suffix on collision
function generateUsername(fullName, existingUsers) {
  const parts = fullName.toLowerCase().trim().replace(/[^a-z\s]/g, '').split(/\s+/);
  if (parts.length === 0) return null;
  
  const first = parts[0];
  const last = parts[parts.length - 1];
  
  // Try 3 formats: first-last, firstlast, first.last
  const candidates = parts.length > 1 
    ? [`${first}-${last}`, `${first}${last}`, `${first}.${last}`]
    : [first];
  
  // Try each candidate format
  for (const base of candidates) {
    if (base.length >= 3 && !existingUsers.find(u => u.username === base)) {
      return base;
    }
  }
  
  // All formats taken, try with 2-digit random suffixes (5 attempts)
  const baseFormat = candidates[0];
  for (let attempt = 0; attempt < 5; attempt++) {
    const suffix = Math.floor(Math.random() * 90) + 10; // 10-99
    const candidate = `${baseFormat}${suffix}`;
    if (!existingUsers.find(u => u.username === candidate)) {
      return candidate;
    }
  }
  
  // Fallback: timestamp-based unique username
  return `${baseFormat}${Date.now().toString().slice(-6)}`;
}

// Validate phone number (E.164 format or +91 prefix)
function validatePhone(phone) {
  if (!phone) return { valid: true }; // Optional field
  const e164Pattern = /^\+[1-9]\d{1,14}$/;
  const indiaPattern = /^\+91[6-9]\d{9}$/;
  if (e164Pattern.test(phone) || indiaPattern.test(phone)) {
    return { valid: true };
  }
  return { valid: false, error: 'Phone must be E.164 format (e.g., +91XXXXXXXXXX)' };
}

dsCreate.addEventListener('click', (e)=> {
  e.preventDefault(); // Prevent form refresh
  dsError.style.display='none';
  
  const name = dsName.value.trim();
  const username = dsUsername.value.trim();
  const password = dsPassword.value;
  const specialty = dsSpecialty.value.trim();
  const countryCode = document.getElementById('ds-country-code').value;
  const phoneNumber = dsPhone.value.trim();
  const phone = phoneNumber ? `${countryCode}-${phoneNumber}` : '';
  const location = dsLocation.value.trim();
  
  // Validate required fields
  if(!name) return showError(dsError,'Please enter full name.');
  if(!password) return showError(dsError,'Please enter password.');
  if(password.length < 6) return showError(dsError,'Password must be >=6 chars.');
  if(!specialty) return showError(dsError,'Please select your specialty.');
  
  // Validate phone if provided
  const phoneValidation = validatePhone(phone);
  if (!phoneValidation.valid) return showError(dsError, phoneValidation.error);
  
  const users = load(USERS_KEY) || [];
  
  // Auto-generate username if not provided
  let unameFinal = username;
  if (!unameFinal) {
    unameFinal = generateUsername(name, users);
    if (!unameFinal) return showError(dsError, 'Could not generate username. Please enter manually.');
  } else {
    // Validate manual username
    if(!/^[a-zA-Z0-9._-]{3,}$/.test(unameFinal)) {
      return showError(dsError,'Username must be >=3 chars (letters/digits . _ -).');
    }
    // Check collision for manual username
    if(users.find(u=> u.username === unameFinal)) {
      return showError(dsError, 'Username already taken. Try another or leave blank for auto-generation.');
    }
  }
  
  // Create account
  users.push({ 
    username: unameFinal, 
    password, 
    role:'doctor', 
    name, 
    specialty, 
    phone, 
    location
  });
  save(USERS_KEY, users);
  sessionStorage.setItem('st_session', JSON.stringify({ username: unameFinal, role:'doctor' }));
  
  // Show success message
  showToast('Doctor account created â€” signed in');
  
  // Clear form AFTER successful creation
  dsName.value=''; 
  dsUsername.value=''; 
  dsPassword.value=''; 
  dsSpecialty.value=''; 
  dsPhone.value=''; 
  dsLocation.value='';
  selectedPlace = null;
  const mapPreview = document.getElementById('clinic-map-preview');
  if (mapPreview) mapPreview.classList.remove('active');
  const coords = document.getElementById('clinic-coords');
  if (coords) coords.textContent = 'Lat: ---, Lng: ---';
  
  // Open dashboard automatically
  renderDoctorDashboard();
});

/* ---------- Doctor login ---------- */
const dlUsername = document.getElementById('dl-username'), dlPassword = document.getElementById('dl-password'), dlLogin = document.getElementById('dl-login'), dlBack = document.getElementById('dl-back'), dlError = document.getElementById('dl-error'), dlGotoSignup = document.getElementById('dl-goto-signup');
dlBack.addEventListener('click', ()=> { dlError.style.display='none'; showPage('page-landing'); });
dlGotoSignup.addEventListener('click', ()=> { dlError.style.display='none'; showPage('page-doctor-signup'); });
dlLogin.addEventListener('click', ()=> {
  dlError.style.display = 'none';
  const username = (dlUsername.value||'').trim();
  const password = dlPassword.value||'';
  if(!username) return showError(dlError, 'Please enter username.');
  if(!password) return showError(dlError, 'Please enter password.');
  const users = load(USERS_KEY) || [];
  const doc = users.find(u => u.role === 'doctor' && (u.username === username));
  if(!doc) return showError(dlError, 'No doctor found with that username. Create one or check username.');
  if(doc.password !== password) return showError(dlError, 'Incorrect password.');
  sessionStorage.setItem('st_session', JSON.stringify({ username: doc.username, role: 'doctor' }));
  showToast('Signed in as ' + (doc.name || doc.username));
  dlUsername.value = ''; dlPassword.value = '';
  // OPEN DOCTOR DASHBOARD AFTER LOGIN:
  renderDoctorDashboard();
});

/* ---------- Google OAuth Sign-In Handler ---------- */
function handleGoogleSignIn(response) {
  try {
    console.log('Google Sign-In Response:', response);
    if (!response.credential) return;

    // Decode JWT token to get user info
    const base64Url = response.credential.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    const userData = JSON.parse(jsonPayload);
    console.log('Google User Data:', userData);

    const users = load(USERS_KEY) || [];
    const patientActive = (pages['page-patient-signup'] && pages['page-patient-signup'].classList.contains('active')) || (pages['page-patient-login'] && pages['page-patient-login'].classList.contains('active'));
    const doctorActive = pages['page-doctor-login'] && pages['page-doctor-login'].classList.contains('active');

    if (patientActive) {
      // Patient OAuth signup/login
      let patient = users.find(u => u.role === 'patient' && u.email === userData.email);
      if (!patient) {
        const base = (userData.email || userData.name || 'patient').split('@')[0].toLowerCase().replace(/[^a-z0-9._-]/g,'').slice(0,20) || 'patient';
        let username = base || 'patient';
        let suffix = 1;
        while (users.find(u => u.username === username)) { username = `${base}${suffix}`; suffix++; }
        patient = {
          username,
          password: 'google_oauth_' + Math.random().toString(36).substr(2, 9),
          role: 'patient',
          name: userData.name || username,
          email: userData.email || '',
          age:'â€”', gender:'â€”', lastCheckup:'â€”'
        };
        users.push(patient);
        save(USERS_KEY, users);
        showToast('Patient account created with Google');
      } else {
        showToast('Signed in as ' + (patient.name || patient.username));
      }
      sessionStorage.setItem('st_session', JSON.stringify({ username: patient.username, role: 'patient' }));
      psName.value=''; psUsername.value=''; psPassword.value='';
      renderPatientDashboard();
      return;
    }

    // Doctor OAuth signup/login (default)
    let doctor = users.find(u => u.email === userData.email && u.role === 'doctor');
    if (!doctor) {
      doctor = {
        username: userData.email.split('@')[0],
        name: userData.name,
        email: userData.email,
        password: 'google_oauth_' + Math.random().toString(36).substr(2, 9),
        role: 'doctor',
        phone: '',
        location: '',
        specialty: 'General Practice',
        createdAt: new Date().toISOString()
      };
      users.push(doctor);
      save(USERS_KEY, users);
      showToast('Welcome! Doctor account created with Google');
    } else {
      showToast('Signed in as ' + (doctor.name || doctor.email));
    }

    sessionStorage.setItem('st_session', JSON.stringify({ username: doctor.username, role: 'doctor' }));
    dlUsername.value = '';
    dlPassword.value = '';
    renderDoctorDashboard();
  } catch (error) {
    console.error('Google Sign-In Error:', error);
    const targetErrorEl = pages['page-patient-signup'].classList.contains('active') ? psError : dlError;
    showError(targetErrorEl, 'Google Sign-In failed: ' + error.message);
  }
}

/* ---------- Symptom / test / suggestion logic (NEW 10 MCQ) ---------- */
const mainSym = document.getElementById('main-sym'), symNext = document.getElementById('sym-next'), symBack = document.getElementById('sym-back');
symBack.addEventListener('click', ()=> showPage('page-patient-signup'));
mainSym.addEventListener('input', ()=> symNext.disabled = !mainSym.value.trim());
symNext.addEventListener('click', ()=> { if(!mainSym.value.trim()) return; prepareTest(mainSym.value.trim()); showPage('page-test'); });

const qCard = document.getElementById('q-card'), qPrev = document.getElementById('q-prev'), qNext = document.getElementById('q-next'), qSave = document.getElementById('q-save'), progressBar = document.getElementById('test-progress-bar'), progressText = document.getElementById('test-progress-text');
const mcqAlert = document.getElementById('mcq-alert'), mcqAlertOk = document.getElementById('mcq-alert-ok');
let testState = { symptom:'', questions:[], answers:[], idx:0 };

function setMcqAlert(show){ if(!mcqAlert) return; mcqAlert.style.display = show ? 'flex' : 'none'; }
if(mcqAlertOk) mcqAlertOk.addEventListener('click', ()=> setMcqAlert(false));

/* ---------- New Booking Modal ---------- */
let currentBookingDoctor = null;
let currentBookingSpecialty = null;

window.openBookingModal = function(doctor, specialty) {
  console.log('Opening booking modal for:', doctor.name, specialty);
  
  currentBookingDoctor = doctor;
  currentBookingSpecialty = specialty;
  
  const modal = document.getElementById('booking-modal');
  const bmName = document.getElementById('bm-doctor-name');
  const bmSpecialty = document.getElementById('bm-specialty');
  const bmAddress = document.getElementById('bm-address');
  const bmMapIframe = document.getElementById('bm-map-iframe');
  const bmError = document.getElementById('bm-error');
  
  if (!modal) {
    console.error('Booking modal not found!');
    return;
  }
  
  // Set modal content
  if (bmName) bmName.textContent = doctor.name || 'Doctor';
  if (bmSpecialty) bmSpecialty.textContent = specialty || 'General Practice';
  
  // Build full address from doctor object
  const fullAddress = doctor.address 
    ? `${doctor.address}${doctor.city ? ', ' + doctor.city : ''}${doctor.state ? ', ' + doctor.state : ''}`
    : (doctor.location || 'Location not available');
  if (bmAddress) bmAddress.textContent = fullAddress;
  
  // Set up interactive map with zoom controls
  let mapQuery;
  if (doctor.lat && doctor.lng) {
    // Use coordinates if available
    mapQuery = `${doctor.lat},${doctor.lng}`;
  } else {
    // Use address as fallback
    mapQuery = encodeURIComponent(fullAddress || doctor.name);
  }
  if (bmMapIframe) bmMapIframe.src = `https://www.google.com/maps?q=${mapQuery}&output=embed&z=15`;
  
  // Clear previous inputs
  const bmMode = document.getElementById('bm-mode');
  const bmDate = document.getElementById('bm-date');
  const bmTime = document.getElementById('bm-time');
  const bmNotes = document.getElementById('bm-notes');
  
  if (bmMode) bmMode.value = 'in_person';
  if (bmDate) bmDate.value = '';
  if (bmTime) bmTime.value = '';
  if (bmNotes) bmNotes.value = '';
  if (bmError) bmError.style.display = 'none';
  
  // Show modal
  modal.style.display = 'flex';
  console.log('Booking modal opened successfully');
}

window.closeBookingModal = function() {
  const modal = document.getElementById('booking-modal');
  if (modal) modal.style.display = 'none';
  currentBookingDoctor = null;
  currentBookingSpecialty = null;
}

// Initialize booking modal event listeners when DOM is ready
function initBookingModal() {
  const bmClose = document.getElementById('bm-close');
  const bmCancel = document.getElementById('bm-cancel');
  const bmBook = document.getElementById('bm-book');
  const bmError = document.getElementById('bm-error');

  if (bmClose) {
    bmClose.addEventListener('click', window.closeBookingModal);
  }

  if (bmCancel) {
    bmCancel.addEventListener('click', window.closeBookingModal);
  }

  if (bmBook) {
    bmBook.addEventListener('click', async () => {
      if (!currentBookingDoctor) {
        console.error('No doctor selected for booking');
        return;
      }
    
    const mode = document.getElementById('bm-mode').value;
    const date = document.getElementById('bm-date').value;
    const time = document.getElementById('bm-time').value;
    const notes = document.getElementById('bm-notes').value;
    
    // Validation
    if (!date || !time) {
      bmError.textContent = 'Please select both date and time';
      bmError.style.display = 'block';
      return;
    }
    
    // Check if appointment is in the past
    const appointmentDateTime = new Date(`${date}T${time}`);
    if (appointmentDateTime < new Date()) {
      bmError.textContent = 'Cannot book appointments in the past';
      bmError.style.display = 'block';
      return;
    }
    
    // Get current session
    const sess = JSON.parse(sessionStorage.getItem('st_session') || 'null');
    if (!sess || sess.role !== 'patient') {
      bmError.textContent = 'Please sign in as a patient first';
      bmError.style.display = 'block';
      return;
    }
    
    // Prepare booking data
    const fullClinicAddress = currentBookingDoctor.address 
      ? `${currentBookingDoctor.address}${currentBookingDoctor.city ? ', ' + currentBookingDoctor.city : ''}${currentBookingDoctor.state ? ', ' + currentBookingDoctor.state : ''}`
      : (currentBookingDoctor.location || '');
    
    const bookingData = {
      patient: sess.username,
      doctor: currentBookingDoctor.name,
      doctorName: currentBookingDoctor.name,
      specialty: currentBookingSpecialty,
      clinic: fullClinicAddress,
      phone: currentBookingDoctor.phone || '',
      mode: mode,
      datetime: appointmentDateTime.toISOString(),
      notes: notes,
      status: 'pending',
      createdAt: new Date().toISOString()
    };
    
    try {
      // Disable button during booking
      bmBook.disabled = true;
      bmBook.textContent = 'Booking...';
      bmError.style.display = 'none';
      
      // Save to localStorage (demo mode)
      const appts = load(APPTS_KEY) || [];
      bookingData.id = 'appt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      appts.push(bookingData);
      save(APPTS_KEY, appts);
      
      // Show success message
      showToast(`Appointment booked with ${currentBookingDoctor.name}`);
      
      // Close modal
      closeBookingModal();

      // Redirect to patient dashboard and refresh view
      if (typeof renderPatientDashboard === 'function') {
        renderPatientDashboard();
      }
      showPage('page-patient-dashboard');
      
      // Reset button
      bmBook.disabled = false;
      bmBook.textContent = 'Book Appointment';
      
    } catch (error) {
      console.error('Booking error:', error);
      bmError.textContent = 'Failed to book appointment. Please try again.';
      bmError.style.display = 'block';
      bmBook.disabled = false;
      bmBook.textContent = 'Book Appointment';
    }
  });
  }

  // Close modal when clicking outside
  const bookingModalOverlay = document.getElementById('booking-modal');
  if (bookingModalOverlay) {
    bookingModalOverlay.addEventListener('click', (e) => {
      if (e.target === bookingModalOverlay) {
        window.closeBookingModal();
      }
    });
  }
  
  console.log('Booking modal initialized');
}

// Call initialization when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initBookingModal);
} else {
  initBookingModal();
}

/* ---------- Doctor Quick-View Modal ---------- */
const doctorQuickModal = document.getElementById('doctor-quick-modal');
const dqmClose = document.getElementById('dqm-close');
const dqmCancel = document.getElementById('dqm-cancel');
const dqmBook = document.getElementById('dqm-book');
const dqmAvatar = document.getElementById('dqm-avatar');
const dqmName = document.getElementById('dqm-name');
const dqmSpecialty = document.getElementById('dqm-specialty');
const dqmMapContainer = document.getElementById('dqm-map-container');
const dqmAddress = document.getElementById('dqm-address');
const dqmPhone = document.getElementById('dqm-phone');
const dqmDistanceRow = document.getElementById('dqm-distance-row');
const dqmDistance = document.getElementById('dqm-distance');
const dqmMode = document.getElementById('dqm-mode');
const dqmDate = document.getElementById('dqm-date');
const dqmTime = document.getElementById('dqm-time');
const dqmNotes = document.getElementById('dqm-notes');
const dqmError = document.getElementById('dqm-error');

let currentDoctorData = null;

function openDoctorQuickModal(doctor, specialty) {
  currentDoctorData = { ...doctor, specialty };
  
  // Set header
  const initials = doctor.name.split(' ').map(n => n[0]).slice(0, 2).join('');
  dqmAvatar.textContent = initials;
  dqmName.textContent = doctor.name;
  dqmSpecialty.textContent = specialty || doctor.specialty || 'General Medicine';
  
  // Set address and phone
  const fullAddress = `${doctor.address || ''}, ${doctor.city || ''}, ${doctor.state || ''}`.trim().replace(/^,\s*|,\s*$/g, '');
  dqmAddress.textContent = fullAddress || 'Address not available';
  dqmPhone.textContent = doctor.phone || 'N/A';
  dqmPhone.href = doctor.phone ? `tel:${doctor.phone}` : '#';
  
  // Map preview or link
  dqmMapContainer.innerHTML = '';
  if (doctor.lat && doctor.lng) {
    // Check if we can embed a map (Google Maps Embed API would need an API key)
    // For now, we'll show a link to open in Google Maps
    const mapLink = document.createElement('a');
    mapLink.className = 'doctor-quick-map-link';
    mapLink.href = doctor.google_place_id 
      ? `https://www.google.com/maps/place/?q=place_id:${doctor.google_place_id}`
      : `https://www.google.com/maps/search/?api=1&query=${doctor.lat},${doctor.lng}`;
    mapLink.target = '_blank';
    mapLink.innerHTML = 'ğŸ“ Open Location in Google Maps';
    dqmMapContainer.appendChild(mapLink);
  } else {
    const noMap = document.createElement('div');
    noMap.className = 'doctor-quick-map-link';
    noMap.style.cursor = 'default';
    noMap.style.opacity = '0.5';
    noMap.textContent = 'ğŸ“ Location not available';
    dqmMapContainer.appendChild(noMap);
  }
  
  // Calculate distance if user location is available
  if (navigator.geolocation && doctor.lat && doctor.lng) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const userLat = position.coords.latitude;
        const userLng = position.coords.longitude;
        const distance = calculateDistance(userLat, userLng, parseFloat(doctor.lat), parseFloat(doctor.lng));
        dqmDistance.textContent = distance.toFixed(1) + ' km';
        dqmDistanceRow.style.display = 'flex';
      },
      () => {
        dqmDistanceRow.style.display = 'none';
      }
    );
  } else {
    dqmDistanceRow.style.display = 'none';
  }
  
  // Set default date/time
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  dqmDate.value = tomorrow.toISOString().split('T')[0];
  dqmDate.min = new Date().toISOString().split('T')[0];
  dqmTime.value = '09:00';
  dqmMode.value = 'in_person';
  dqmNotes.value = '';
  dqmError.style.display = 'none';
  
  // Show modal
  doctorQuickModal.style.display = 'flex';
  
  // Focus trap - focus first input
  dqmMode.focus();
}

function closeDoctorQuickModal() {
  doctorQuickModal.style.display = 'none';
  currentDoctorData = null;
}

// Helper function to calculate distance using Haversine formula
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // Radius of Earth in km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Close modal handlers
dqmClose.addEventListener('click', closeDoctorQuickModal);
dqmCancel.addEventListener('click', closeDoctorQuickModal);

// Close on backdrop click
doctorQuickModal.addEventListener('click', (e) => {
  if (e.target === doctorQuickModal) closeDoctorQuickModal();
});

// ESC key handler
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && doctorQuickModal.style.display === 'flex') {
    closeDoctorQuickModal();
  }
});

// Book appointment handler
dqmBook.addEventListener('click', async () => {
  dqmError.style.display = 'none';
  
  // Validate inputs
  if (!dqmDate.value || !dqmTime.value) {
    dqmError.textContent = 'Please select date and time';
    dqmError.style.display = 'block';
    return;
  }
  
  const selectedDate = new Date(dqmDate.value + 'T' + dqmTime.value);
  if (selectedDate < new Date()) {
    dqmError.textContent = 'Cannot book appointments in the past';
    dqmError.style.display = 'block';
    return;
  }
  
  // Check if user is logged in as patient
  const sess = JSON.parse(sessionStorage.getItem('st_session') || 'null');
  if (!sess || sess.role !== 'patient') {
    dqmError.textContent = 'You must be logged in as a patient to book';
    dqmError.style.display = 'block';
    setTimeout(() => {
      closeDoctorQuickModal();
      showPage('page-patient-signup');
    }, 2000);
    return;
  }
  
  // Disable button while submitting
  dqmBook.disabled = true;
  dqmBook.textContent = 'Booking...';
  
  try {
    const mode = dqmMode.value;
    const notes = dqmNotes.value.trim();
    const startDT = new Date(dqmDate.value + 'T' + dqmTime.value);
    const endDT = new Date(startDT.getTime() + 30 * 60000); // 30 min appointment
    
    // Try backend API first
    const token = sessionStorage.getItem('st_token');
    if (token) {
      const payload = {
        doctorId: currentDoctorData.id ? String(currentDoctorData.id) : '1',
        patientId: String(sess.userId || sess.id || '1'),
        startTime: startDT.toISOString(),
        endTime: endDT.toISOString(),
        mode: mode,
        notes: notes || undefined
      };
      
      const response = await fetch('/api/appointments/book', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json', 
          'Authorization': `Bearer ${token}` 
        },
        body: JSON.stringify(payload)
      }).catch(() => null);
      
      if (response && response.ok) {
        const result = await response.json();
        if (result.ok) {
          showToast(`âœ“ Appointment booked with ${currentDoctorData.name}`);
          closeDoctorQuickModal();
          
          // Refresh dashboard if available and redirect
          if (window.renderPatientDashboard) window.renderPatientDashboard();
          showPage('page-patient-dashboard');
          
          dqmBook.disabled = false;
          dqmBook.textContent = 'Book Appointment';
          return;
        }
      }
    }
    
    // Fallback: localStorage-based booking
    const appts = load(APPTS_KEY) || [];
    const users = load(USERS_KEY) || [];
    const patient = users.find(u => u.username === sess.username);
    
    const appt = {
      id: 'a-' + Date.now(),
      patient: sess.username,
      patientName: patient ? patient.name : sess.username,
      doctorName: currentDoctorData.name,
      doctorPhone: currentDoctorData.phone || 'N/A',
      clinic: currentDoctorData.clinic || currentDoctorData.location || 'Clinic',
      datetime: startDT.toISOString(),
      startTime: startDT.toISOString(),
      endTime: endDT.toISOString(),
      mode: mode,
      notes: notes,
      status: 'confirmed',
      createdAt: new Date().toISOString()
    };
    
    appts.unshift(appt);
    save(APPTS_KEY, appts);
    
    // Update request status if from MCQ suggestion
    const lastSuggestion = JSON.parse(sessionStorage.getItem('st_last_suggestion') || 'null');
    if (lastSuggestion) {
      const reqs = load(REQS_KEY) || [];
      const idx = reqs.findIndex(r => 
        r.patient === sess.username && 
        r.specialty === currentDoctorData.specialty && 
        r.status === 'pending'
      );
      if (idx >= 0) {
        reqs[idx].status = 'confirmed';
        reqs[idx].doctor = currentDoctorData.name;
        reqs[idx].apptId = appt.id;
        save(REQS_KEY, reqs);
      }
    }
    
    showToast(`âœ“ Booked with ${currentDoctorData.name} â€” ${startDT.toLocaleString()}`);
    closeDoctorQuickModal();
    
    // Refresh patient dashboard and redirect
    if (window.renderPatientDashboard) window.renderPatientDashboard();
    showPage('page-patient-dashboard');
    
  } catch (error) {
    dqmError.textContent = 'Error: ' + error.message;
    dqmError.style.display = 'block';
  } finally {
    dqmBook.disabled = false;
    dqmBook.textContent = 'Book Appointment';
  }
});

function prepareTest(symptom){
  // Exact 10 MCQs as specified in requirements
  const standardQuestions = [
    {q:'Where is your main problem located?', opts:['Head / face / ears / nose / throat','Chest / breathing / heart','Arms / legs / joints / back'], answerKey:'q1'},
    {q:'Which best describes the pain?', opts:['Sharp / stabbing','Dull / aching / constant','Burning / tingling / numbness'], answerKey:'q2'},
    {q:'Any fever or signs of infection?', opts:['Yes â€” high fever (>38Â°C)','Mild fever or chills','No fever'], answerKey:'q3'},
    {q:'Any recent skin changes (rash, bump, ulcer)?', opts:['Yes â€” rash or visible lesion','Itching or mild irritation','No skin changes'], answerKey:'q4'},
    {q:'Any problems with hearing, voice, or swallowing?', opts:['Yes â€” hearing loss / ear pain / voice change / difficulty swallowing','Mild sore throat / congestion','No'], answerKey:'q5'},
    {q:'Any shortness of breath, chest pain, or palpitations?', opts:['Yes â€” severe or sudden','Mild exertional breathlessness or palpitations','No'], answerKey:'q6'},
    {q:'Any digestive symptoms (abdominal pain, vomiting, blood in stool)?', opts:['Severe abdominal pain / vomiting / blood','Mild indigestion / nausea','No digestive symptoms'], answerKey:'q7'},
    {q:'Any recent injury or trauma to the affected area?', opts:['Yes â€” recent fracture/sprain/major injury','Minor injury / strain','No injury'], answerKey:'q8'},
    {q:'Any mood / sleep / concentration changes recently?', opts:['Severe changes â€” suicidal thoughts / inability to function','Low mood / anxiety / sleep issues','No mental health concerns'], answerKey:'q9'},
    {q:'Are you pregnant or could you be pregnant? (if applicable)', opts:['Yes / unsure','Not now but trying/planning','Not pregnant / not applicable'], answerKey:'q10'}
  ];
  
  testState.symptom = symptom;
  testState.questions = standardQuestions;
  testState.answers = Array(standardQuestions.length).fill(null);
  testState.idx = 0;
  renderQuestion();
}
function renderQuestion(){
  const i = testState.idx, item = testState.questions[i];
  qCard.innerHTML = '';
  const qTitle = document.createElement('div'); qTitle.className='question'; qTitle.textContent = (i+1)+'. '+item.q;
  const opts = document.createElement('div'); opts.className='options';
  item.opts.forEach(opt=>{
    const el = document.createElement('div'); el.className='option'; el.textContent = opt;
    if(testState.answers[i]===opt) el.classList.add('selected');
    el.addEventListener('click', ()=> { testState.answers[i]=opt; renderQuestion(); updateProgress(); sessionStorage.setItem('st_test_autosave', JSON.stringify(testState)); });
    opts.appendChild(el);
  });
  qCard.appendChild(qTitle); qCard.appendChild(opts);
  qPrev.disabled = i===0; qNext.textContent = (i===testState.questions.length-1)?'Finish':'Next â–¶';
  updateProgress();
}
function updateProgress(){ const done = testState.answers.filter(a=>a!==null).length, total=testState.questions.length, pct=Math.round((done/total)*100); progressBar.style.width=pct+'%'; progressText.textContent = done + '/' + total; }
qPrev.addEventListener('click', ()=> { if(testState.idx>0){ testState.idx--; renderQuestion(); }});
qNext.addEventListener('click', ()=> { 
  if(!testState.answers[testState.idx]) { 
    setMcqAlert(true); 
    return; 
  } 
  if(testState.idx < testState.questions.length-1){ 
    testState.idx++; 
    renderQuestion(); 
    return; 
  } 
  // On last question (Finish button), call computeSuggestionAndShow
  computeSuggestionAndShow(); 
});
qSave.addEventListener('click', ()=> { sessionStorage.setItem('st_test_autosave', JSON.stringify(testState)); alert('Progress saved.'); showPage('page-main-symptom'); document.getElementById('main-sym').value = testState.symptom; symNext.disabled = false; });

/* ---------- Calculate severity based on symptom answers ---------- */
function calculateSeverity(answers) {
  let severityScore = 0;
  
  // Severe indicators that increase severity
  const severeIndicators = [
    // Q1: Location (moderate)
    answers[0] === 'Chest / breathing / heart' ? 1 : 0,
    // Q2: Pain type - sharp/stabbing is more severe
    answers[1] === 'Sharp / stabbing' ? 2 : 0,
    // Q3: Fever - high fever is severe
    answers[2] === 'Yes â€” high fever (>38Â°C)' ? 2 : 0,
    // Q4: Skin changes - visible lesion is moderate
    answers[3] === 'Yes â€” rash or visible lesion' ? 1 : 0,
    // Q5: Hearing/voice/swallowing - severe issues
    answers[4] === 'Yes â€” hearing loss / ear pain / voice change / difficulty swallowing' ? 1 : 0,
    // Q6: Breathing/chest - severe/sudden is critical
    answers[5] === 'Yes â€” severe or sudden' ? 3 : 0,
    // Q7: Digestive - severe with blood is critical
    answers[6] === 'Severe abdominal pain / vomiting / blood' ? 3 : 0,
    // Q8: Injury - major injury is severe
    answers[7] === 'Yes â€” recent fracture/sprain/major injury' ? 2 : 0,
    // Q9: Mental health - severe is critical
    answers[8] === 'Severe changes â€” suicidal thoughts / inability to function' ? 3 : 0,
    // Q10: Pregnancy related
    answers[9] === 'Yes / unsure' ? 1 : 0
  ];
  
  severityScore = severeIndicators.reduce((a, b) => a + b, 0);
  
  // Determine severity level
  if (severityScore >= 6) {
    return 'Critical';
  } else if (severityScore >= 4) {
    return 'High';
  } else if (severityScore >= 2) {
    return 'Moderate';
  } else {
    return 'Low';
  }
}

/* ---------- Deterministic scoring algorithm ---------- */
function mapAnswersToSpecialties(answers) {
  // Initialize scores for all specialties
  const scores = {
    GP: 0,
    ENT: 0,
    Cardiology: 0,
    Dermatology: 0,
    Orthopedics: 0,
    Neurology: 0,
    Gastroenterology: 0,
    Psychiatry: 0,
    'Obstetrics/Gynecology': 0,
    'Infectious Diseases': 0
  };
  
  // Q1: Location mapping
  if (answers[0] === 'Head / face / ears / nose / throat') {
    scores.ENT += 2;
    scores.Neurology += 1;
  } else if (answers[0] === 'Chest / breathing / heart') {
    scores.Cardiology += 2;
  } else if (answers[0] === 'Arms / legs / joints / back') {
    scores.Orthopedics += 2;
  }
  
  // Q2: Pain description
  if (answers[1] === 'Sharp / stabbing') {
    scores.Neurology += 1;
  } else if (answers[1] === 'Dull / aching / constant') {
    scores.GP += 1;
  } else if (answers[1] === 'Burning / tingling / numbness') {
    scores.Neurology += 2;
  }
  
  // Q3: Fever/infection
  if (answers[2] === 'Yes â€” high fever (>38Â°C)') {
    scores['Infectious Diseases'] += 2;
    scores.GP += 1;
  } else if (answers[2] === 'Mild fever or chills') {
    scores.GP += 1;
  }
  
  // Q4: Skin changes
  if (answers[3] === 'Yes â€” rash or visible lesion') {
    scores.Dermatology += 2;
  } else if (answers[3] === 'Itching or mild irritation') {
    scores.Dermatology += 1;
  }
  
  // Q5: Hearing/voice/swallowing
  if (answers[4] === 'Yes â€” hearing loss / ear pain / voice change / difficulty swallowing') {
    scores.ENT += 2;
  } else if (answers[4] === 'Mild sore throat / congestion') {
    scores.ENT += 1;
    scores.GP += 1;
  }
  
  // Q6: Breathing/chest/palpitations
  if (answers[5] === 'Yes â€” severe or sudden') {
    scores.Cardiology += 2;
  } else if (answers[5] === 'Mild exertional breathlessness or palpitations') {
    scores.Cardiology += 1;
  }
  
  // Q7: Digestive symptoms
  if (answers[6] === 'Severe abdominal pain / vomiting / blood') {
    scores.Gastroenterology += 2;
  } else if (answers[6] === 'Mild indigestion / nausea') {
    scores.Gastroenterology += 1;
  }
  
  // Q8: Injury/trauma
  if (answers[7] === 'Yes â€” recent fracture/sprain/major injury') {
    scores.Orthopedics += 2;
  } else if (answers[7] === 'Minor injury / strain') {
    scores.Orthopedics += 1;
  }
  
  // Q9: Mental health
  if (answers[8] === 'Severe changes â€” suicidal thoughts / inability to function') {
    scores.Psychiatry += 2;
  } else if (answers[8] === 'Low mood / anxiety / sleep issues') {
    scores.Psychiatry += 1;
  }
  
  // Q10: Pregnancy
  if (answers[9] === 'Yes / unsure') {
    scores['Obstetrics/Gynecology'] += 2;
  } else if (answers[9] === 'Not now but trying/planning') {
    scores['Obstetrics/Gynecology'] += 1;
  }
  
  // Sort by score and select top specialties with score >= 2
  const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
  let selected = sorted.filter(([k, v]) => v >= 2).slice(0, 3).map(([k, v]) => k);
  
  // If no specialty reaches threshold, default to GP
  if (selected.length === 0) selected = ['GP'];
  
  return selected;
}

/* ---------- Suggestion and matching (NEW with backend integration) ---------- */
async function computeSuggestionAndShow(){
  try {
    console.log('Starting suggestion computation...');
    
    // Disable finish button while processing
    const qNextBtn = document.getElementById('q-next');
    if (qNextBtn) {
      qNextBtn.disabled = true;
      qNextBtn.textContent = 'Processing...';
    }
    
    console.log('Test answers:', testState.answers);
    
    // Prepare answers object
    const answersObj = {};
    testState.answers.forEach((ans, idx) => {
      answersObj[`q${idx + 1}`] = ans === testState.questions[idx].opts[0] ? 'a' :
                                   ans === testState.questions[idx].opts[1] ? 'b' : 'c';
    });
    
    console.log('Answers object:', answersObj);
    
    // Call backend API for recommendations
    console.log('Calling backend API...');
    const response = await fetch('http://localhost:8000/api/symptom-recommendations', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        patientLocation: { lat: 22.5726, lng: 88.3639 }, // Default Kolkata, can be made dynamic
        answers: answersObj
      })
    });
    
    console.log('Backend response status:', response.status);
    
    if (!response.ok) throw new Error(`Backend error: ${response.status}`);
    
    const data = await response.json();
    console.log('Backend data:', data);
    
    if (data.ok && data.recommendations && data.recommendations.length > 0) {
      // Backend returned recommendations
      console.log('Displaying backend recommendations');
      displayRecommendations(data);
    } else {
      throw new Error('No recommendations from backend');
    }
    
  } catch (error) {
    // Fallback to client-side logic if backend fails
    console.warn('Using client-side fallback:', error.message);
    console.log('Computing specialties client-side...');
    const specialties = mapAnswersToSpecialties(testState.answers);
    console.log('Specialties:', specialties);
    
    const fallbackData = {
      ok: true,
      specialties: specialties,
      recommendations: specialties.map(spec => ({
        specialty: spec,
        doctors: getDemoDoctors(spec)
      }))
    };
    console.log('Displaying fallback recommendations');
    displayRecommendations(fallbackData);
  } finally {
    // Re-enable finish button
    const qNextBtn = document.getElementById('q-next');
    if (qNextBtn) {
      qNextBtn.disabled = false;
      qNextBtn.textContent = 'Finish';
    }
    console.log('Suggestion computation completed');
  }
}

function getDemoDoctors(specialty) {
  // Fallback demo doctors with Google Maps data
  const demoData = {
    'GP': [{name:'Dr. Anil Kumar', phone:'+91-9001122334', address:'12 Main St, Kolkata', lat:22.5726, lng:88.3639, google_place_id:'ChIJZ_YISduC-DkRvCxsj-Yw40M'}],
    'ENT': [{name:'Dr. Rajesh Sharma', phone:'+91-9123456780', address:'45 Park Street, Kolkata', lat:22.5541, lng:88.3516, google_place_id:'ChIJYRz5RtuC-DkR8jI6dCm0a6c'}],
    'Cardiology': [{name:'Dr. Arup Sen', phone:'+91-9880012345', address:'Bangalore Heart Clinic, MG Road', lat:22.5726, lng:88.3639, google_place_id:'ChIJZ_YISduC-DkRvCxsj-Yw40M'}],
    'Dermatology': [{name:'Dr. Soma Mitra', phone:'+91-9876543210', address:'SkinCare Hub, Kolkata', lat:22.5411, lng:88.3523, google_place_id:'ChIJYRz5RtuC-DkR8jI6dCm0a6c'}],
    'Orthopedics': [{name:'Dr. Vikram Singh', phone:'+91-9966554433', address:'OrthoPlus, Delhi', lat:28.6139, lng:77.2090, google_place_id:'ChIJL_P_CXMEDTkRw0ZdG-0GVvw'}],
    'Neurology': [{name:'Dr. Neha Verma', phone:'+91-9988776655', address:'Neuro Care, Mumbai', lat:19.0760, lng:72.8777, google_place_id:'ChIJwe1EZjDG5zsRaYxkjY_tpF0'}],
    'Gastroenterology': [{name:'Dr. Amit Patel', phone:'+91-9876501234', address:'Gastro Clinic, Ahmedabad', lat:23.0225, lng:72.5714, google_place_id:'ChIJSdRbuoqEXjkRFmVPYRHdzk8'}],
    'Psychiatry': [{name:'Dr. Priya Menon', phone:'+91-9123450987', address:'Mind Care, Bangalore', lat:12.9716, lng:77.5946, google_place_id:'ChIJbU60yXAWrjsR4E9-UejD3_g'}],
    'Obstetrics/Gynecology': [{name:'Dr. Meera Patel', phone:'+91-9012345678', address:'Women Care Clinic, Ahmedabad', lat:23.0225, lng:72.5714, google_place_id:'ChIJSdRbuoqEXjkRFmVPYRHdzk8'}],
    'Infectious Diseases': [{name:'Dr. Sandeep Roy', phone:'+91-9876009876', address:'Infectious Disease Center, Kolkata', lat:22.5726, lng:88.3639, google_place_id:'ChIJZ_YISduC-DkRvCxsj-Yw40M'}]
  };
  return demoData[specialty] || demoData['GP'];
}

function displayRecommendations(data) {
  // Show only the top/first specialty, not all of them
  const specialty = data.specialties && data.specialties.length > 0 ? data.specialties[0] : 'General Medicine';
  const severity = calculateSeverity(testState.answers);
  
  console.log('Displaying recommendations for specialty:', specialty, 'severity:', severity);
  console.log('Data:', data);
  
  document.getElementById('suggest-specialty').textContent = specialty;
  const severityElement = document.getElementById('suggest-confidence');
  severityElement.textContent = severity;
  
  // Apply color class based on severity level
  severityElement.className = '';
  if (severity === 'Critical') {
    severityElement.classList.add('severity-critical');
  } else if (severity === 'High') {
    severityElement.classList.add('severity-high');
  } else if (severity === 'Moderate') {
    severityElement.classList.add('severity-moderate');
  } else if (severity === 'Low') {
    severityElement.classList.add('severity-low');
  }
  
  const list = document.getElementById('doctor-list');
  list.innerHTML = '';
  console.log('Clearing doctor list and starting to populate...');
  
  // Display all recommended doctors from all specialties
  data.recommendations.forEach(rec => {
    rec.doctors.forEach(d => {
      const item = document.createElement('div');
      item.className = 'doctor-item';
      item.style.marginBottom = '12px';
      item.style.padding = '12px';
      item.style.background = 'rgba(255,255,255,0.02)';
      item.style.borderRadius = '12px';
      item.style.border = '1px solid rgba(255,255,255,0.04)';
      item.style.cursor = 'pointer';
      item.style.transition = 'all 0.2s ease';
      
      // Make entire card clickable to open modal
      item.addEventListener('click', (e) => {
        // Don't trigger if clicking on a button or link
        if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'A') {
          openDoctorQuickModal(d, rec.specialty);
        }
      });
      
      item.addEventListener('mouseenter', () => {
        item.style.transform = 'translateY(-2px)';
        item.style.boxShadow = '0 8px 24px rgba(0,0,0,0.3)';
        item.style.border = '1px solid rgba(123,97,255,0.2)';
      });
      
      item.addEventListener('mouseleave', () => {
        item.style.transform = 'none';
        item.style.boxShadow = 'none';
        item.style.border = '1px solid rgba(255,255,255,0.04)';
      });
      
      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.gap = '12px';
      header.style.alignItems = 'center';
      header.style.marginBottom = '10px';
      
      const av = document.createElement('div');
      av.className = 'doc-avatar';
      av.textContent = d.name.split(' ').map(n => n[0]).slice(0, 2).join('');
      
      const meta = document.createElement('div');
      meta.style.flex = '1';
      const name = document.createElement('div');
      name.className = 'doc-name';
      name.textContent = d.name;
      name.style.fontWeight = '700';
      name.style.fontSize = '16px';
      name.style.cursor = 'pointer';
      
      const specBadge = document.createElement('div');
      specBadge.textContent = rec.specialty;
      specBadge.style.fontSize = '11px';
      specBadge.style.color = 'var(--accent1)';
      specBadge.style.marginTop = '2px';
      
      meta.appendChild(name);
      meta.appendChild(specBadge);
      header.appendChild(av);
      header.appendChild(meta);
      
      const contact = document.createElement('div');
      contact.style.marginBottom = '8px';
      contact.style.fontSize = '13px';
      contact.style.color = 'var(--muted)';
      contact.innerHTML = `ğŸ“ ${d.phone}<br>ğŸ“ ${d.address}, ${d.city}, ${d.state}`;
      
      const ops = document.createElement('div');
      ops.style.display = 'flex';
      ops.style.gap = '8px';
      ops.style.flexWrap = 'wrap';
      
      // Google Maps link button
      const mapsBtn = document.createElement('a');
      mapsBtn.className = 'btn ghost';
      mapsBtn.style.fontSize = '12px';
      mapsBtn.style.padding = '6px 10px';
      mapsBtn.textContent = 'ğŸ“ Open in Maps';
      if (d.google_place_id) {
        mapsBtn.href = `https://www.google.com/maps/place/?q=place_id:${d.google_place_id}`;
      } else {
        mapsBtn.href = `https://www.google.com/maps/search/?api=1&query=${d.lat},${d.lng}`;
      }
      mapsBtn.target = '_blank';
      
      const callBtn = document.createElement('a');
      callBtn.className = 'btn ghost';
      callBtn.style.fontSize = '12px';
      callBtn.style.padding = '6px 10px';
      callBtn.textContent = 'ğŸ“ Call';
      callBtn.href = `tel:${d.phone}`;
      
      const book = document.createElement('button');
      book.className = 'btn primary';
      book.style.fontSize = '12px';
      book.style.padding = '6px 10px';
      book.textContent = 'Book Appointment';
      book.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log('Book button clicked for:', d.name);
        window.openBookingModal(d, rec.specialty);
      });
      
      ops.appendChild(mapsBtn);
      ops.appendChild(callBtn);
      ops.appendChild(book);
      
      item.appendChild(header);
      item.appendChild(contact);
      item.appendChild(ops);
      list.appendChild(item);
    });
  });
  
  sessionStorage.setItem('st_last_suggestion', JSON.stringify({
    specialty,
    matched: data.recommendations.flatMap(r => r.doctors),
    severity,
    symptom: testState.symptom,
    answers: testState.answers
  }));
  
  console.log('Navigating to suggestions page...');
  showPage('page-suggest');
  console.log('Recommendations displayed successfully');
}

/* ---------- Booking ---------- */
function handleBook(doctor){
  const sess = JSON.parse(sessionStorage.getItem('st_session')||'null');
  if(!sess || sess.role!=='patient'){
    if(confirm('You must be logged in as a patient to book. Sign up now?')) showPage('page-patient-signup');
    return;
  }
  const appts = load(APPTS_KEY) || [];
  const when = new Date();
  const appt = { id:'a-'+Date.now(), patient:sess.username, patientName: (load(USERS_KEY)||[]).find(u=>u.username===sess.username)?.name || sess.username, doctorName: doctor.name, doctorPhone: doctor.phone||'N/A', clinic: doctor.location||'Clinic', datetime: when.toISOString(), status:'confirmed', createdAt:new Date().toISOString() };
  appts.unshift(appt); save(APPTS_KEY, appts);

  const reqs = load(REQS_KEY) || [];
  const lastSuggestion = JSON.parse(sessionStorage.getItem('st_last_suggestion')||'null');
  if(lastSuggestion){
    const idx = reqs.findIndex(r => r.patient === sess.username && r.specialty === lastSuggestion.specialty && r.status === 'pending');
    if(idx >= 0){ reqs[idx].status = 'confirmed'; reqs[idx].doctor = doctor.name; reqs[idx].apptId = appt.id; save(REQS_KEY, reqs); }
  }
  showToast(`Booked with ${doctor.name} â€” ${new Date(appt.datetime).toLocaleString()}`);
  // refresh patient dashboard
  renderPatientDashboard();
}

/* ---------- Send request ---------- */
document.getElementById('send-request')?.addEventListener('click', ()=> {
  const sess = JSON.parse(sessionStorage.getItem('st_session')||'null');
  if(!sess || sess.role!=='patient'){ if(confirm('You must be signed in as a patient. Sign up now?')) showPage('page-patient-signup'); return; }
  const last = JSON.parse(sessionStorage.getItem('st_last_suggestion')||'null');
  if(!last){ alert('Nothing to send'); return; }
  const reqs = load(REQS_KEY) || [];
  const req = { id:'req-'+Date.now(), patient: sess.username, patientName: (load(USERS_KEY)||[]).find(u=>u.username===sess.username)?.name || sess.username, symptom: last.symptom, specialty: last.specialty, answers: last.answers, status: 'pending', createdAt:new Date().toISOString() };
  reqs.unshift(req); save(REQS_KEY, reqs);
  showToast('Request sent to specialists.');
  showPage('page-landing');
});
document.getElementById('suggest-back')?.addEventListener('click', ()=> showPage('page-test'));

/* ---------- Small helpers ---------- */
function showError(container, msg){ container.textContent = msg; container.style.display = 'block'; container.scrollIntoView({behavior:'smooth', block:'center'}); }
function showToast(msg, ms=2600){ const t = document.getElementById('toast'); t.textContent = msg; t.style.display='block'; t.style.opacity='1'; setTimeout(()=> { t.style.transition='opacity .4s'; t.style.opacity='0'; setTimeout(()=>{ t.style.display='none'; t.style.transition=''; },420); }, ms); }

// Confirmation modal helper
function showConfirm(title, message, onConfirm, onCancel) {
  const modal = document.getElementById('confirm-modal');
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-message').textContent = message;
  
  const okBtn = document.getElementById('confirm-ok-btn');
  const cancelBtn = document.getElementById('confirm-cancel-btn');
  
  // Remove old listeners
  const newOkBtn = okBtn.cloneNode(true);
  const newCancelBtn = cancelBtn.cloneNode(true);
  okBtn.parentNode.replaceChild(newOkBtn, okBtn);
  cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
  
  document.getElementById('confirm-ok-btn').addEventListener('click', ()=> {
    modal.style.display = 'none';
    if(onConfirm) onConfirm();
  });
  
  document.getElementById('confirm-cancel-btn').addEventListener('click', ()=> {
    modal.style.display = 'none';
    if(onCancel) onCancel();
  });
  
  modal.style.display = 'flex';
}

/* ---------- Doctor Dashboard logic (new) ---------- */
function seedDemoIfEmpty(){
  const reqs = load(REQS_KEY) || [];
  if(!reqs || reqs.length===0){
    const now = new Date();
    const demo = [
      { id:'req-'+Date.now(), patient:'pritam.s', patientName:'Pritam Sahoo', symptom:'Chest pain and breathlessness', specialty:'Cardiology', answers:['2 days','Rapidly','Yes','Yes'], status:'pending', createdAt: new Date(now - 1000*60*60).toISOString() },
      { id:'req-'+(Date.now()+1), patient:'alex.k', patientName:'Alex Kumar', symptom:'Small rash on arm', specialty:'Dermatology', answers:['1 day','No','No','No'], status:'pending', createdAt: new Date(now - 1000*60*30).toISOString() },
      { id:'req-'+(Date.now()+2), patient:'sara.p', patientName:'Sara Paul', symptom:'Back pain after fall', specialty:'Orthopedics', answers:['>3 days','Yes','No','No'], status:'pending', createdAt: new Date(now - 1000*60*60*5).toISOString() }
    ];
    save(REQS_KEY, demo);
  }
}
seedDemoIfEmpty();

function computeUrgency(symptom, answers){
  const text = (symptom + ' ' + (answers||[]).join(' ')).toLowerCase();
  if(/breath|shortness|faint|unconscious|severe|heavy bleeding|difficulty breathing/.test(text)) return 'high';
  if(/pain|fever|worsen|swelling|bleeding/.test(text)) return 'medium';
  return 'low';
}

function renderDoctorDashboard(){
  const sess = JSON.parse(sessionStorage.getItem('st_session')||'null');
  if(!sess || sess.role!=='doctor'){ showPage('page-doctor-login'); return; }
  const user = (load(USERS_KEY)||[]).find(u=>u.username===sess.username) || {};
  document.getElementById('doctor-welcome').textContent = `Welcome, ${user.name || sess.username} ${user.specialty ? 'â€” '+user.specialty : ''}`;

  const reqs = (load(REQS_KEY) || []).slice().sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
  const appts = (load(APPTS_KEY) || []).filter(a=> a.status !== 'cancelled').slice().sort((a,b)=> new Date(a.datetime) - new Date(b.datetime));

  // KPIs
  const pending = reqs.filter(r=> r.status === 'pending').length;
  const todayIso = new Date().toISOString().split('T')[0];
  const todayAppts = appts.filter(a=> a.datetime && a.datetime.split('T')[0] === todayIso).length;
  const unresolved = reqs.filter(r=> r.status !== 'resolved' && r.status !== 'rejected').length;
  document.getElementById('kpi-pending').textContent = pending;
  document.getElementById('kpi-today').textContent = todayAppts;
  document.getElementById('kpi-unresolved').textContent = unresolved;

  // requests list
  const rl = document.getElementById('requests-list'); rl.innerHTML = '';
  reqs.forEach(r=>{
    const urgency = computeUrgency(r.symptom, r.answers);
    const item = document.createElement('div'); item.className = 'req-item';
    const av = document.createElement('div'); av.className = 'req-avatar'; av.textContent = (r.patientName||r.patient||'U').split(' ').map(x=>x[0]).slice(0,2).join('');
    const main = document.createElement('div'); main.className = 'req-main';
    const title = document.createElement('div'); title.className = 'req-title'; title.textContent = (r.patientName || r.patient) + ' â€” ' + r.symptom;
    const meta = document.createElement('div'); meta.className = 'tiny'; meta.textContent = `Created: ${new Date(r.createdAt).toLocaleString()} â€¢ ${r.specialty || 'General'}`;
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
    const viewBtn = document.createElement('button'); viewBtn.className='btn ghost'; viewBtn.textContent='View'; viewBtn.addEventListener('click', ()=> openRequestModal(r.id));
    actions.appendChild(viewBtn);
    if(r.status === 'pending'){
      const accept = document.createElement('button'); accept.className='btn primary'; accept.textContent='Accept'; accept.addEventListener('click', ()=> openRequestModal(r.id, true));
      actions.appendChild(accept);
    }
    main.appendChild(title); main.appendChild(meta); main.appendChild(actions);
    const badge = document.createElement('div'); badge.className = 'badge ' + (urgency==='high'?'high':urgency==='medium'?'medium':'low'); badge.textContent = urgency.toUpperCase();
    item.appendChild(av); item.appendChild(main); item.appendChild(badge);
    rl.appendChild(item);
  });

  // appts list
  const al = document.getElementById('appt-list'); al.innerHTML = '';
  appts.forEach(a=>{
    const ap = document.createElement('div'); ap.className = 'appt-item';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${a.patientName}</div><div class="tiny">${new Date(a.datetime).toLocaleString()}</div>`;
    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
    const call = document.createElement('a'); call.className='btn ghost'; call.textContent='Call'; call.href = 'tel:' + (a.doctorPhone || '');
    const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancel'; cancel.addEventListener('click', ()=> { showConfirm('Cancel Appointment', `Are you sure you want to cancel the appointment with ${a.patientName}?`, ()=> cancelAppointment(a.id)); });
    right.appendChild(call); right.appendChild(cancel);
    ap.appendChild(left); ap.appendChild(right);
    al.appendChild(ap);
  });

  // show dashboard page
  showPage('page-doctor-dashboard');
}

/* ---------- Patient dashboard renderer ---------- */
function renderPatientDashboard(){
  const sess = JSON.parse(sessionStorage.getItem('st_session')||'null');
  if(!sess || sess.role!=='patient'){ showPage('page-patient-signup'); return; }
  const user = (load(USERS_KEY)||[]).find(u=>u.username===sess.username) || { name: sess.username };
  // header
  document.getElementById('patient-name').textContent = `Hello, ${user.name.split(' ')[0] || user.username} ğŸ‘‹`;
  document.getElementById('patient-avatar').textContent = user.name.split(' ').map(n=>n[0]).slice(0,2).join('');
  document.getElementById('patient-quick').textContent = `Age: ${user.age||'â€”'} â€¢ Gender: ${user.gender||'â€”'} â€¢ Last check-up: ${user.lastCheckup||'â€”'}`;

  // requests
  const reqs = (load(REQS_KEY) || []).filter(r=> r.patient === sess.username);
  const rcont = document.getElementById('dash-requests'); rcont.innerHTML = '';
  if(!reqs.length) rcont.innerHTML = '<div class="tiny" style="color:var(--muted)">No requests yet â€” send one from "Send Request".</div>';
  reqs.forEach(r=>{
    const d = document.createElement('div'); d.className='timeline-item';
    d.innerHTML = `<div style="font-weight:700">${r.symptom}</div><div class="tiny">Specialty: ${r.specialty} â€¢ ${new Date(r.createdAt).toLocaleString()} â€¢ Status: ${r.status}</div>`;
    rcont.appendChild(d);
  });

  // appointments
  const appts = (load(APPTS_KEY) || []).filter(a=> a.patient === sess.username && a.status !== 'cancelled');
  const acont = document.getElementById('dash-appointments'); acont.innerHTML = '';
  if(!appts.length) acont.innerHTML = '<div class="tiny" style="color:var(--muted)">No appointments found.</div>';
  appts.forEach(a=>{
    const d = document.createElement('div'); d.className='timeline-item'; d.style.display='flex'; d.style.justifyContent='space-between'; d.style.alignItems='center';
    const info = document.createElement('div');
    info.innerHTML = `<div style="font-weight:700">${a.doctorName || 'Doctor'}</div><div class="tiny">${new Date(a.datetime).toLocaleString()} â€¢ ${a.specialty || ''} â€¢ Mode: ${a.mode || 'video'}</div><div class="tiny" style="color:var(--muted); margin-top:4px;">${a.clinic || ''}</div><div class="tiny" style="color:#4ade80; margin-top:4px;">Status: ${a.status}</div>`;
    
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
    const viewBtn = document.createElement('button'); viewBtn.className='btn ghost'; viewBtn.textContent='Details'; viewBtn.style.padding='6px 12px'; viewBtn.style.fontSize='12px'; 
    viewBtn.addEventListener('click', ()=> {
      // Show appointment details in custom modal
      const detailsModal = document.createElement('div');
      detailsModal.className = 'modal-backdrop';
      detailsModal.innerHTML = `
        <div class="modal">
          <h3>Appointment Details</h3>
          <div style="margin-top:12px;">
            <div><strong>Doctor:</strong> ${a.doctorName}</div>
            <div style="margin-top:8px;"><strong>Specialty:</strong> ${a.specialty || 'General'}</div>
            <div style="margin-top:8px;"><strong>Date & Time:</strong> ${new Date(a.datetime).toLocaleString()}</div>
            <div style="margin-top:8px;"><strong>Mode:</strong> ${a.mode || 'video'}</div>
            <div style="margin-top:8px;"><strong>Clinic:</strong> ${a.clinic || 'N/A'}</div>
            <div style="margin-top:8px;"><strong>Status:</strong> <span style="color:#4ade80;">${a.status}</span></div>
            <div style="margin-top:8px;"><strong>Notes:</strong> ${a.notes || 'None'}</div>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
            <button type="button" class="btn ghost" onclick="this.parentElement.parentElement.parentElement.style.display='none';">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(detailsModal);
      detailsModal.addEventListener('click', (e)=> { if(e.target === detailsModal) detailsModal.remove(); });
    });
    
    const cancelBtn = document.createElement('button'); cancelBtn.className='btn'; cancelBtn.textContent='Cancel'; cancelBtn.style.padding='6px 12px'; cancelBtn.style.fontSize='12px'; cancelBtn.style.color='#ef4444';
    cancelBtn.addEventListener('click', ()=> {
      showConfirm('Cancel Appointment', `Are you sure you want to cancel the appointment with ${a.doctorName}?`, ()=> {
        const allAppts = load(APPTS_KEY) || [];
        const idx = allAppts.findIndex(x => x.id === a.id);
        if(idx >= 0) {
          allAppts[idx].status = 'cancelled';
          save(APPTS_KEY, allAppts);
          renderPatientDashboard();
          showToast('Appointment cancelled');
        }
      });
    });
    
    actions.appendChild(viewBtn);
    actions.appendChild(cancelBtn);
    d.appendChild(info);
    d.appendChild(actions);
    acont.appendChild(d);
  });

  // reports (demo)
  const rps = (user.reports || []);
  const rpscont = document.getElementById('dash-reports'); rpscont.innerHTML = '';
  if(!rps.length) rpscont.innerHTML = '<div class="tiny" style="color:var(--muted)">No reports uploaded (demo).</div>';
  const fmtSize = (bytes)=>{
    if(!bytes && bytes!==0) return '';
    if(bytes < 1024) return `${bytes} B`;
    if(bytes < 1024*1024) return `${(bytes/1024).toFixed(1)} KB`;
    return `${(bytes/1024/1024).toFixed(1)} MB`;
  };
  rps.forEach(rep=>{
    const info = typeof rep === 'string' ? { name: rep } : rep || {};
    const el = document.createElement('div'); el.className='timeline-item';
    const added = info.addedAt ? new Date(info.addedAt).toLocaleString() : '';
    const size = fmtSize(info.size);
    const meta = [info.type, size, added].filter(Boolean).join(' â€¢ ');
    const downloadLink = info.data ? `<a href="${info.data}" download="${info.name||'report'}" style="color:var(--accent1);text-decoration:none">Download</a>` : '';
    el.innerHTML = `<div style="font-weight:700">${info.name || 'Report'}</div><div class="tiny" style="color:var(--muted);margin-top:4px">${meta || 'Uploaded file'}</div>${downloadLink ? `<div class="tiny" style="margin-top:6px">${downloadLink}</div>`:''}`;
    rpscont.appendChild(el);
  });

  // timeline
  const timeline = load(TIMELINE_KEY) || {};
  const list = (timeline[sess.username] || []);
  const tcont = document.getElementById('dash-timeline'); tcont.innerHTML = '';
  if(!list.length) tcont.innerHTML = '<div class="tiny" style="color:var(--muted)">No logs yet â€” add daily notes below.</div>';
  list.slice().reverse().forEach(it=>{
    const el = document.createElement('div'); el.className='timeline-item'; el.innerHTML = `<div style="font-weight:700">${it.text}</div><div class="tiny">${new Date(it.at).toLocaleString()}</div>`;
    tcont.appendChild(el);
  });

  // saved doctors demo
  const sd = user.savedDoctors || [];
  const sdc = document.getElementById('dash-saved-doctors'); sdc.innerHTML = '';
  if(!sd.length) sdc.innerHTML = '<div class="tiny" style="color:var(--muted)">No saved doctors yet.</div>';
  sd.forEach(d=>{
    const el = document.createElement('div'); el.className='timeline-item'; el.innerHTML = `<div style="font-weight:700">${d.name}</div><div class="tiny">${d.location || ''} â€¢ ${d.phone || ''}</div>`;
    sdc.appendChild(el);
  });

  // notifications (demo)
  const nots = (load('st_notifs') || []).filter(n=> n.to === sess.username || n.to === 'all');
  const nc = document.getElementById('dash-notifs'); nc.innerHTML = '';
  if(!nots.length) nc.innerHTML = '<div class="tiny" style="color:var(--muted)">No notifications.</div>';
  nots.forEach(n=>{
    const el = document.createElement('div'); el.className='timeline-item'; el.innerHTML = `<div style="font-weight:700">${n.title}</div><div class="tiny">${n.body} â€¢ ${new Date(n.at).toLocaleString()}</div>`;
    nc.appendChild(el);
  });

  // show dashboard page
  showPage('page-patient-dashboard');
}

/* ---------- Request modal interactions ---------- */
const reqModal = document.getElementById('req-modal'), reqTitle = document.getElementById('req-title'), reqMeta = document.getElementById('req-meta'), reqBody = document.getElementById('req-body'), reqReject = document.getElementById('req-reject'), reqAccept = document.getElementById('req-accept'), reqBookForm = document.getElementById('req-book-form'), bookDate = document.getElementById('book-date'), bookTime = document.getElementById('book-time'), bookCancel = document.getElementById('book-cancel'), bookConfirm = document.getElementById('book-confirm');
let activeRequestId = null;
function openRequestModal(reqId, openBook = false){
  const reqs = load(REQS_KEY) || [];
  const r = reqs.find(x=> x.id === reqId);
  if(!r) return;
  activeRequestId = reqId;
  reqTitle.textContent = `${r.patientName || r.patient} â€” ${r.specialty || 'General'}`;
  reqMeta.textContent = `Created: ${new Date(r.createdAt).toLocaleString()} â€¢ Status: ${r.status}`;
  reqBody.innerHTML = `<div style="margin-top:8px">${r.symptom}</div><div class="tiny" style="margin-top:8px">Answers: ${(r.answers||[]).join(' | ')}</div>`;
  reqBookForm.style.display = openBook ? 'block' : 'none';
  if(openBook){
    const dt = new Date(); dt.setHours(dt.getHours()+1);
    bookDate.value = dt.toISOString().slice(0,10);
    bookTime.value = ('0'+dt.getHours()).slice(-2)+':00';
  }
  reqModal.style.display = 'flex';
}

/* ---------- Report upload (PDF/JPG) ---------- */
const repInput = document.getElementById('report-file');
const repChoose = document.getElementById('report-choose');
const repChosen = document.getElementById('report-chosen');
const repUpload = document.getElementById('report-upload');

if(repChoose && repInput){
  repChoose.addEventListener('click', ()=> repInput.click());
  repInput.addEventListener('change', ()=>{
    const f = repInput.files && repInput.files[0];
    if(!f){ repChosen.textContent = 'No file chosen'; return; }
    repChosen.textContent = `${f.name} (${Math.round(f.size/1024)} KB)`;
  });
}

function persistUser(updated){
  const users = load(USERS_KEY) || [];
  const idx = users.findIndex(u=> u.username === updated.username);
  if(idx >= 0) { users[idx] = updated; save(USERS_KEY, users); return true; }
  return false;
}

if(repUpload && repInput){
  repUpload.addEventListener('click', ()=>{
    const file = repInput.files && repInput.files[0];
    if(!file){ showToast('Please choose a PDF or JPG'); return; }
    if(!['application/pdf','image/jpeg','image/png'].includes(file.type)){
      showToast('Only PDF or JPG/PNG files allowed');
      return;
    }
    const sess = JSON.parse(sessionStorage.getItem('st_session')||'null');
    if(!sess || sess.role !== 'patient'){ showToast('Please sign in as patient first'); return; }
    const users = load(USERS_KEY) || [];
    const user = users.find(u=> u.username === sess.username);
    if(!user){ showToast('User not found. Please sign in again.'); return; }

    const reader = new FileReader();
    reader.onload = () => {
      const report = {
        name: file.name,
        type: file.type,
        size: file.size,
        data: reader.result,
        addedAt: new Date().toISOString()
      };
      user.reports = user.reports || [];
      user.reports.push(report);
      persistUser(user);
      repInput.value = '';
      repChosen.textContent = 'No file chosen';
      showToast('Report uploaded');
      renderPatientDashboard();
    };
    reader.readAsDataURL(file);
  });
}
reqReject.addEventListener('click', ()=> {
  if(!activeRequestId) return;
  const reqs = load(REQS_KEY) || []; const idx = reqs.findIndex(r=> r.id === activeRequestId); if(idx < 0) return;
  reqs[idx].status = 'rejected'; save(REQS_KEY, reqs); reqModal.style.display = 'none'; renderDoctorDashboard(); showToast('Request rejected');
});
reqAccept.addEventListener('click', ()=> { reqBookForm.style.display = 'block'; });
bookCancel.addEventListener('click', ()=> { reqBookForm.style.display = 'none'; });

// Enable/disable confirm button based on form validation
function validateBookingForm() {
  const dateVal = bookDate.value, timeVal = bookTime.value, endTimeVal = document.getElementById('book-end-time')?.value;
  const modeVal = document.getElementById('book-mode')?.value;
  if(dateVal && timeVal && endTimeVal && modeVal) {
    bookConfirm.disabled = false;
  } else {
    bookConfirm.disabled = true;
  }
}

bookDate.addEventListener('change', validateBookingForm);
bookTime.addEventListener('change', validateBookingForm);
document.getElementById('book-end-time')?.addEventListener?.('change', validateBookingForm);
document.getElementById('book-mode')?.addEventListener?.('change', validateBookingForm);
bookConfirm.addEventListener('click', async ()=> {
  if(!activeRequestId && !window.currentBookingRequest) return;
  
  // Get form values
  const dateVal = bookDate.value, timeVal = bookTime.value, endTimeVal = document.getElementById('book-end-time')?.value;
  if(!dateVal || !timeVal || !endTimeVal) return alert('Please fill all date/time fields');
  
  // Validate times
  const startDT = new Date(`${dateVal}T${timeVal}:00Z`);
  const endDT = new Date(`${dateVal}T${endTimeVal}:00Z`);
  if(isNaN(startDT) || isNaN(endDT)) return alert('Invalid date/time format');
  if(startDT >= endDT) return alert('Start time must be before end time');
  if(startDT < new Date()) return alert('Cannot book appointments in the past');
  
  // Disable button and show loading state
  bookConfirm.disabled = true;
  bookConfirm.textContent = 'Booking...';
  
  try {
    // Try backend API first (if using app.js flow)
    if(window.currentBookingRequest) {
      const mode = document.getElementById('book-mode')?.value || 'video';
      const notes = document.getElementById('book-notes')?.value || '';
      const sess = window.session || JSON.parse(sessionStorage.getItem('rt_session')||'null');
      const token = window.currentDoctorToken || sess?.token || 'local';
      const docId = window.currentDoctorId || sess?.userId;
      
      const payload = {
        requestId: String(window.currentBookingRequest.id),
        doctorId: String(docId),
        patientId: String(window.currentBookingRequest.patientId),
        startTime: startDT.toISOString(),
        endTime: endDT.toISOString(),
        mode: mode,
        notes: notes || undefined
      };
      
      const response = await fetch('/api/appointments/book', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify(payload)
      }).catch(()=> null);
      
      if(response && response.ok) {
        const result = await response.json();
        if(result.ok) {
          // Update request status
          const allReqs = load(REQUESTS_KEY, []) || load(REQS_KEY, []);
          const reqIdx = allReqs.findIndex(x => x.id === window.currentBookingRequest.id);
          if(reqIdx >= 0) { allReqs[reqIdx].status = 'booked'; save(REQUESTS_KEY || REQS_KEY, allReqs); }
          
          reqModal.style.display = 'none';
          showToast('âœ“ Appointment booked successfully!');
          window.currentBookingRequest = null;
          
          // Refresh dashboard
          if(window.renderDoctorProfileAndRequests) window.renderDoctorProfileAndRequests();
          else if(window.renderDoctorDashboard) window.renderDoctorDashboard();
          
          bookConfirm.disabled = false;
          bookConfirm.textContent = 'Confirm Booking';
          return;
        }
      }
    }
    
    // Fallback: localStorage-based booking (HTML flow)
    if(activeRequestId) {
      const reqs = load(REQS_KEY) || []; 
      const idx = reqs.findIndex(r=> r.id === activeRequestId); 
      if(idx < 0) return alert('Request not found');
      
      reqs[idx].status = 'booked';
      save(REQS_KEY, reqs);
      
      const sess = JSON.parse(sessionStorage.getItem('st_session')||'null'); 
      const doc = (load(USERS_KEY)||[]).find(u=> u.username === (sess && sess.username));
      const mode = document.getElementById('book-mode')?.value || 'video';
      const notes = document.getElementById('book-notes')?.value || '';
      
      const appts = load(APPTS_KEY) || [];
      const appt = { 
        id:'a-'+Date.now(), 
        patient: reqs[idx].patient, 
        patientName: reqs[idx].patientName, 
        doctor: doc ? doc.username : '', 
        doctorName: doc ? doc.name : '', 
        doctorPhone: doc ? doc.phone : '', 
        clinic: doc ? (doc.location || '') : '', 
        datetime: startDT.toISOString(),
        startTime: startDT.toISOString(),
        endTime: endDT.toISOString(),
        mode: mode,
        notes: notes,
        status:'confirmed', 
        createdAt: new Date().toISOString() 
      };
      appts.unshift(appt);
      save(APPTS_KEY, appts);
      
      reqModal.style.display = 'none';
      showToast('âœ“ Appointment created');
      if(window.renderDoctorDashboard) window.renderDoctorDashboard();
    }
    
  } catch(error) {
    alert('Error: ' + error.message);
  } finally {
    bookConfirm.disabled = false;
    bookConfirm.textContent = 'Confirm Booking';
  }
});
reqModal.addEventListener('click', (e)=> { if(e.target === reqModal) reqModal.style.display = 'none'; });

/* ---------- Appointment cancel ---------- */
function cancelAppointment(apptId){
  const appts = load(APPTS_KEY) || []; const idx = appts.findIndex(a=> a.id === apptId); if(idx<0) return;
  appts[idx].status = 'cancelled'; save(APPTS_KEY, appts); renderDoctorDashboard(); showToast('Appointment cancelled');
}

/* ---------- Quick dashboard controls ---------- */
document.getElementById('doctor-back')?.addEventListener('click', ()=> showPage('page-landing'));
document.getElementById('edit-profile-btn')?.addEventListener('click', ()=> {
  const sess = JSON.parse(sessionStorage.getItem('st_session')||'null');
  if(!sess) return;
  const user = (load(USERS_KEY)||[]).find(u=>u.username===sess.username);
  if(!user) return;
  
  // Pre-fill form with current data
  document.getElementById('ep-name').value = user.name || '';
  document.getElementById('ep-specialty').value = user.specialty || '';
  
  // Split phone into country code and number
  const userPhone = user.phone || '';
  if (userPhone) {
    const phoneParts = userPhone.match(/^(\+\d+)-(.+)$/);
    if (phoneParts) {
      document.getElementById('ep-country-code').value = phoneParts[1];
      document.getElementById('ep-phone').value = phoneParts[2];
    } else {
      document.getElementById('ep-country-code').value = '+91';
      document.getElementById('ep-phone').value = userPhone;
    }
  } else {
    document.getElementById('ep-country-code').value = '+91';
    document.getElementById('ep-phone').value = '';
  }
  
  document.getElementById('ep-location').value = user.location || '';
  document.getElementById('ep-password').value = '';
  document.getElementById('ep-error').style.display = 'none';
  document.getElementById('ep-success').style.display = 'none';
  
  // Set photo preview
  const photoPreview = document.getElementById('ep-photo-preview');
  if(user.photo) {
    photoPreview.style.backgroundImage = `url('${user.photo}')`;
    photoPreview.style.backgroundSize = 'cover';
    photoPreview.style.backgroundPosition = 'center';
    photoPreview.textContent = '';
  } else {
    photoPreview.style.backgroundImage = 'none';
    photoPreview.textContent = 'ğŸ“·';
  }
  
  // Store current user for later use
  window.currentEditingDoctor = user;
  
  showPage('page-doctor-edit-profile');
});

// Photo upload handler
document.getElementById('ep-photo-input')?.addEventListener('change', (e)=> {
  const file = e.target.files[0];
  if(!file) return;
  
  if(!['image/jpeg','image/png','image/gif','image/webp'].includes(file.type)){
    alert('Only JPG, PNG, GIF, or WebP images allowed');
    return;
  }
  
  if(file.size > 5 * 1024 * 1024) {
    alert('File size must be less than 5MB');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = (event)=> {
    const photoData = event.target.result;
    const photoPreview = document.getElementById('ep-photo-preview');
    photoPreview.style.backgroundImage = `url('${photoData}')`;
    photoPreview.style.backgroundSize = 'cover';
    photoPreview.style.backgroundPosition = 'center';
    photoPreview.textContent = '';
    
    // Store photo in window for save
    window.newPhotoData = photoData;
  };
  reader.readAsDataURL(file);
});

document.getElementById('ep-cancel')?.addEventListener('click', ()=> showPage('page-doctor-dashboard'));
document.getElementById('ep-save')?.addEventListener('click', ()=> {
  const epError = document.getElementById('ep-error');
  const epSuccess = document.getElementById('ep-success');
  epError.style.display = 'none';
  epSuccess.style.display = 'none';
  
  const name = document.getElementById('ep-name').value.trim();
  const specialty = document.getElementById('ep-specialty').value;
  const countryCode = document.getElementById('ep-country-code').value;
  const phoneNumber = document.getElementById('ep-phone').value.trim();
  const phone = phoneNumber ? `${countryCode}-${phoneNumber}` : '';
  const location = document.getElementById('ep-location').value.trim();
  const newPassword = document.getElementById('ep-password').value;
  
  if(!name) { epError.textContent = 'Name is required'; epError.style.display='block'; return; }
  if(!specialty) { epError.textContent = 'Specialty is required'; epError.style.display='block'; return; }
  if(newPassword && newPassword.length < 6) { epError.textContent = 'Password must be at least 6 characters'; epError.style.display='block'; return; }
  
  const sess = JSON.parse(sessionStorage.getItem('st_session')||'null');
  if(!sess) { epError.textContent = 'Session expired. Please login again'; epError.style.display='block'; return; }
  
  const users = load(USERS_KEY) || [];
  const idx = users.findIndex(u=>u.username===sess.username);
  if(idx < 0) { epError.textContent = 'User not found'; epError.style.display='block'; return; }
  
  users[idx].name = name;
  users[idx].specialty = specialty;
  users[idx].phone = phone;
  users[idx].location = location;
  if(newPassword) users[idx].password = newPassword;
  if(window.newPhotoData) {
    users[idx].photo = window.newPhotoData;
    window.newPhotoData = null;
  }
  
  save(USERS_KEY, users);
  epSuccess.textContent = 'âœ“ Profile updated successfully!';
  epSuccess.style.display = 'block';
  
  setTimeout(()=> {
    showPage('page-doctor-dashboard');
    renderDoctorDashboard();
  }, 1500);
});
document.getElementById('refresh-dashboard').addEventListener('click', ()=> renderDoctorDashboard());
document.getElementById('toggle-online').addEventListener('click', function(){ if(this.textContent.includes('Offline')){ this.textContent='Go Online'; showToast('You are now online'); } else { this.textContent='Go Offline'; showToast('You are now offline'); } });
document.getElementById('doctor-logout').addEventListener('click', ()=> { sessionStorage.removeItem('st_session'); showToast('Logged out'); showPage('page-landing'); });

/* ---------- PATIENT EDIT PROFILE ---------- */
// Photo upload handler for patient
document.getElementById('pep-photo-input')?.addEventListener('change', (e)=> {
  const file = e.target.files[0];
  if(!file) return;
  
  if(!['image/jpeg','image/png','image/gif','image/webp'].includes(file.type)){
    alert('Only JPG, PNG, GIF, or WebP images allowed');
    return;
  }
  
  if(file.size > 5 * 1024 * 1024) {
    alert('File size must be less than 5MB');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = (event)=> {
    const photoData = event.target.result;
    const photoPreview = document.getElementById('pep-photo-preview');
    photoPreview.style.backgroundImage = `url('${photoData}')`;
    photoPreview.style.backgroundSize = 'cover';
    photoPreview.style.backgroundPosition = 'center';
    photoPreview.textContent = '';
    
    // Store photo in window for save
    window.newPatientPhotoData = photoData;
  };
  reader.readAsDataURL(file);
});

// Load patient profile data when page opens
function loadPatientProfile() {
  const sess = JSON.parse(sessionStorage.getItem('st_session')||'null');
  if(!sess || sess.role !== 'patient') return;
  
  const users = load(USERS_KEY) || [];
  const user = users.find(u=>u.username===sess.username);
  if(!user) return;
  
  // Populate form fields
  document.getElementById('pep-name').value = user.name || '';
  document.getElementById('pep-age').value = user.age !== 'â€”' ? user.age : '';
  document.getElementById('pep-gender').value = user.gender !== 'â€”' ? user.gender : '';
  document.getElementById('pep-email').value = user.email || '';
  document.getElementById('pep-address').value = user.address || '';
  
  // Handle phone number split
  if(user.phone && user.phone.includes('-')) {
    const parts = user.phone.split('-');
    document.getElementById('pep-country-code').value = parts[0];
    document.getElementById('pep-phone').value = parts.slice(1).join('-');
  } else {
    document.getElementById('pep-country-code').value = '+91';
    document.getElementById('pep-phone').value = '';
  }
  
  // Handle lastCheckup date
  if(user.lastCheckup && user.lastCheckup !== 'â€”') {
    document.getElementById('pep-lastCheckup').value = user.lastCheckup;
  }
  
  // Load photo if exists
  const photoPreview = document.getElementById('pep-photo-preview');
  if(user.photo) {
    photoPreview.style.backgroundImage = `url('${user.photo}')`;
    photoPreview.style.backgroundSize = 'cover';
    photoPreview.style.backgroundPosition = 'center';
    photoPreview.textContent = '';
  } else {
    photoPreview.style.backgroundImage = '';
    photoPreview.textContent = 'ğŸ‘¤';
  }
  
  // Clear password field
  document.getElementById('pep-password').value = '';
  
  // Clear error/success messages
  document.getElementById('pep-error').style.display = 'none';
  document.getElementById('pep-success').style.display = 'none';
}

document.getElementById('pep-cancel')?.addEventListener('click', ()=> {
  showPage('page-patient-dashboard');
  renderPatientDashboard();
});

document.getElementById('pep-save')?.addEventListener('click', ()=> {
  const pepError = document.getElementById('pep-error');
  const pepSuccess = document.getElementById('pep-success');
  pepError.style.display = 'none';
  pepSuccess.style.display = 'none';
  
  const name = document.getElementById('pep-name').value.trim();
  const age = document.getElementById('pep-age').value.trim();
  const gender = document.getElementById('pep-gender').value;
  const email = document.getElementById('pep-email').value.trim();
  const countryCode = document.getElementById('pep-country-code').value;
  const phoneNumber = document.getElementById('pep-phone').value.trim();
  const phone = phoneNumber ? `${countryCode}-${phoneNumber}` : '';
  const address = document.getElementById('pep-address').value.trim();
  const lastCheckup = document.getElementById('pep-lastCheckup').value;
  const newPassword = document.getElementById('pep-password').value;
  
  if(!name) { pepError.textContent = 'Name is required'; pepError.style.display='block'; return; }
  if(age && (isNaN(age) || age < 1 || age > 120)) { pepError.textContent = 'Please enter a valid age (1-120)'; pepError.style.display='block'; return; }
  if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { pepError.textContent = 'Please enter a valid email address'; pepError.style.display='block'; return; }
  if(newPassword && newPassword.length < 6) { pepError.textContent = 'Password must be at least 6 characters'; pepError.style.display='block'; return; }
  
  const sess = JSON.parse(sessionStorage.getItem('st_session')||'null');
  if(!sess) { pepError.textContent = 'Session expired. Please login again'; pepError.style.display='block'; return; }
  
  const users = load(USERS_KEY) || [];
  const idx = users.findIndex(u=>u.username===sess.username);
  if(idx < 0) { pepError.textContent = 'User not found'; pepError.style.display='block'; return; }
  
  users[idx].name = name;
  users[idx].age = age || 'â€”';
  users[idx].gender = gender || 'â€”';
  users[idx].email = email;
  users[idx].phone = phone;
  users[idx].address = address;
  users[idx].lastCheckup = lastCheckup || 'â€”';
  if(newPassword) users[idx].password = newPassword;
  if(window.newPatientPhotoData) {
    users[idx].photo = window.newPatientPhotoData;
    window.newPatientPhotoData = null;
  }
  
  save(USERS_KEY, users);
  pepSuccess.textContent = 'âœ“ Profile updated successfully!';
  pepSuccess.style.display = 'block';
  
  setTimeout(()=> {
    showPage('page-patient-dashboard');
    renderPatientDashboard();
  }, 1500);
});

/* ---------- CHAT BOT LOGIC ---------- */
const chatBtn = document.getElementById('chat-btn-float');
const chatWindow = document.getElementById('chat-window');
const chatClose = document.getElementById('chat-close');
const chatInput = document.getElementById('chat-input');
const chatSend = document.getElementById('chat-send');
const chatBody = document.getElementById('chat-body');

// Toggle Window
function toggleChat() {
  const isActive = chatWindow.classList.contains('active');
  if (isActive) {
    chatWindow.classList.remove('active');
  } else {
    chatWindow.classList.add('active');
    setTimeout(() => chatInput.focus(), 100);
  }
}

chatBtn.addEventListener('click', toggleChat);
chatClose.addEventListener('click', toggleChat);

// Add Message to DOM
function addMsg(text, type) {
  const el = document.createElement('div');
  el.className = 'chat-msg ' + type;
  el.textContent = text;
  chatBody.appendChild(el);
  chatBody.scrollTop = chatBody.scrollHeight;
}

// Handle Input
chatSend.addEventListener('click', handleChatSubmit);
chatInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') handleChatSubmit();
});

function handleChatSubmit() {
  const txt = (chatInput.value || '').trim();
  if (!txt) return;

  // 1. Add User Message
  addMsg(txt, 'user');
  chatInput.value = '';

  // 2. Bot Logic (Simulated AI Response)
  setTimeout(() => {
    const lower = txt.toLowerCase();
    let suggestion = '';

    if (/fever|temperature|febr|hot/.test(lower)) {
      suggestion = "Home tips: rest, increase fluids, paracetamol if >38Â°C (follow dosing), cool compress to forehead. If breathlessness, persistent high fever, confusion â†’ see a doctor.";
    } else if (/chest|pain|angina|tighten|pressure|breath/.test(lower)) {
      suggestion = "Warning: chest pain can be serious. Sit down, avoid exertion. If severe/worsening/shortness of breath or sweating/fainting â†’ seek emergency care immediately.";
    } else if (/rash|itch|skin|eczema|red/.test(lower)) {
      suggestion = "Home tips: avoid scratching, gentle cleansers, cool compress, calamine for itching, keep area clean. If spreading rapidly, blistering, fever â†’ see dermatologist.";
    } else if (/back|joint|pain|sprain|fracture/.test(lower)) {
      suggestion = "Home tips: rest, ice for first 48 hours for sprain, elevation if swelling, avoid heavy lifting. If deformity, inability to move/weight-bear â†’ see orthopedics.";
    } else if (/hello|hi|hey/.test(lower)) {
      suggestion = "Hello! How can I help you today? Tell me what you are feeling.";
    } else {
      suggestion = "General advice: rest, hydration, monitor symptoms. If symptoms are severe (breathing difficulty, heavy bleeding, fainting, sudden severe pain) seek medical care.";
    }
    addMsg(suggestion, 'bot');
  }, 600);
}

/* ---------- Patient dashboard interactions ---------- */
document.getElementById('timeline-add').addEventListener('click', ()=> {
  const txt = (document.getElementById('timeline-note').value||'').trim();
  if(!txt) return alert('Add a note');
  const s = JSON.parse(sessionStorage.getItem('st_session')||'null');
  if(!s) return alert('Login required');
  const all = load(TIMELINE_KEY) || {};
  all[s.username] = all[s.username] || [];
  all[s.username].push({ text: txt, at: new Date().toISOString() });
  save(TIMELINE_KEY, all);
  document.getElementById('timeline-note').value='';
  renderPatientDashboard();
});

document.getElementById('patient-logout').addEventListener('click', ()=> {
  sessionStorage.removeItem('st_session'); showToast('Logged out'); showPage('page-landing');
});
document.getElementById('dash-symptom-btn').addEventListener('click', ()=> showPage('page-main-symptom'));
document.getElementById('dash-new-request').addEventListener('click', ()=> {
  const s = JSON.parse(sessionStorage.getItem('st_session')||'null'); if(!s) { showPage('page-patient-signup'); return; }
  const last = JSON.parse(sessionStorage.getItem('st_last_suggestion')||'null') || { symptom: 'General', specialty: 'General Medicine', answers: [] };
  const reqs = load(REQS_KEY) || [];
  const req = { id:'req-'+Date.now(), patient: s.username, patientName: (load(USERS_KEY)||[]).find(u=>u.username===s.username)?.name || s.username, symptom: last.symptom, specialty: last.specialty, answers: last.answers, status: 'pending', createdAt:new Date().toISOString() };
  reqs.unshift(req); save(REQS_KEY, reqs);
  showToast('Request sent');
  renderPatientDashboard();
});

/* Subscription handlers */
document.getElementById('sub-gold-btn')?.addEventListener('click', ()=> subscribePlan('Gold Member'));
document.getElementById('sub-family-btn')?.addEventListener('click', ()=> subscribePlan('Family Shield'));
document.getElementById('sub-basic-btn')?.addEventListener('click', ()=> subscribePlan('Basic'));
document.getElementById('sub-back-btn')?.addEventListener('click', goBackFromSub);

/* bottom nav */
document.getElementById('nav-home').addEventListener('click', ()=> renderPatientDashboard());
document.getElementById('nav-appts').addEventListener('click', ()=> { showPage('page-patient-dashboard'); document.getElementById('nav-appts').blur(); });
document.getElementById('nav-reports').addEventListener('click', ()=> { showPage('page-patient-dashboard'); });
document.getElementById('nav-profile').addEventListener('click', ()=> { 
  showPage('page-patient-edit-profile'); 
  loadPatientProfile(); 
});

/* small shortcuts */
document.getElementById('open-sub').addEventListener('click', ()=> openSubscriptionPage());
document.getElementById('open-profile').addEventListener('click', ()=> { 
  showPage('page-patient-edit-profile'); 
  loadPatientProfile(); 
});

const miniDoctorLogin = document.getElementById('mini-doctor-login');
const miniDoctorCreate = document.getElementById('mini-doctor-create');
if(miniDoctorLogin) miniDoctorLogin.addEventListener('click', ()=> showPage('page-doctor-login'));
if(miniDoctorCreate) miniDoctorCreate.addEventListener('click', ()=> showPage('page-doctor-signup'));

/* ---------- On load: resume session (updated) ---------- */
window.addEventListener('load', ()=> {
  const s = JSON.parse(sessionStorage.getItem('st_session')||'null');
  if(s){
    if(s.role === 'patient'){ renderPatientDashboard(); const autos = JSON.parse(sessionStorage.getItem('st_test_autosave')||'null'); if(autos && autos.symptom) document.getElementById('main-sym').value = autos.symptom; symNext.disabled = !document.getElementById('main-sym').value.trim(); }
    else if(s.role === 'doctor'){ renderDoctorDashboard(); }
  } else showPage('page-landing');
});
</script>
</body>
</html>
